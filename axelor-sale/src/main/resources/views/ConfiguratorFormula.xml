<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.4.xsd">


  <grid name="configurator-formula-grid" title="Calculated fields on configurator"
    model="com.axelor.apps.sale.db.ConfiguratorFormula">
    <field name="fieldName"/>
    <field name="formula"/>
    <field name="showOnConfigurator"/>
  </grid>

  <form name="configurator-formula-form" title="Calculated fields on configurator"
    model="com.axelor.apps.sale.db.ConfiguratorFormula"
    onNew="action-configurator-formula-group-on-new"
    onLoad="action-configurator-formula-group-on-load">
    <panel-tabs>
      <panel name="editorPanel" title="Editor" itemSpan="12">
        <panel name="mainPanel">
          <panel name="fieldPanel" colSpan="6">
            <field name="metaField" title="Field" showIf="typeSelect == 1 || typeSelect == 2"
              colSpan="12" onChange="action-configurator-formula-attr-display-meta-json-field"
              onSelect="action-configurator-formula-attrs-set-meta-field-domain"/>
            <field name="metaJsonField" hidden="true" title="Custom field"
              onSelect="action-configurator-formula-attr-on-select-meta-json-field"/>
            <panel name="freeIndicatorPanel" showIf="typeSelect == 3" colSpan="12">
              <field name="freeIndicatorName" x-pattern="[a-z][a-zA-Z0-9_\\$]+" colSpan="6"/>
              <field name="freeIndicatorTitle" colSpan="6"/>
            </panel>
          </panel>
          <field name="formula" widget="CodeEditor" colSpan="12" x-code-syntax="groovy"/>
          <field name="typeSelect" colSpan="4"
            onChange="action-configurator-formula-group-type-select-change"/>
          <field name="showOnConfigurator" colSpan="4"
            readonlyIf="metaField.relationship == 'OneToMany' || typeSelect == 3"/>
          <field showIf="typeSelect == 2" name="updateFromSelect" colSpan="4"/>
          <field name="metaField.relationship" hidden="true"/>
        </panel>
        <panel name="actionPanel">
          <button name="checkScriptsBtn" title="Check the script"
            onClick="save,action-configurator-formula-method-check-script"/>
        </panel>
      </panel>
      <panel-include view="incl-help-configurator-formula"/>
    </panel-tabs>
  </form>

  <action-group name="action-configurator-formula-group-on-new">
    <action name="action-configurator-formula-record-default-type"/>
    <action name="action-configurator-formula-attrs-set-meta-field-title"/>
    <action name="action-configurator-formula-attrs-set-type-select-selection-in"/>
  </action-group>

  <action-group name="action-configurator-formula-group-on-load">
    <action name="action-configurator-formula-attrs-set-meta-field-title"/>
    <action name="action-configurator-formula-attrs-set-type-select-selection-in"/>
    <action name="action-configurator-formula-attr-display-meta-json-field"/>
  </action-group>

  <action-group name="action-configurator-formula-group-type-select-change">
    <action name="action-configurator-formula-record-type-select-onchange"/>
    <action name="action-configurator-formula-attrs-set-meta-field-title"/>
  </action-group>

  <action-method name="action-configurator-formula-method-check-script">
    <call class="com.axelor.apps.sale.web.ConfiguratorFormulaController"
      method="checkGroovyFormula"/>
  </action-method>

  <action-attrs name="action-configurator-formula-attrs-set-meta-field-domain">
    <attribute for="metaField" name="domain"
      if="typeSelect == __repo__(ConfiguratorFormula).TYPE_SALE_ORDER_LINE"
      expr="eval: &quot;self.metaModel.name = 'SaleOrderLine'&quot;"/>
    <attribute for="metaField" name="domain"
      if="typeSelect == __repo__(ConfiguratorFormula).TYPE_PRODUCT"
      expr="eval: &quot;self.metaModel.name = 'Product' AND self.name != 'configurator'&quot;"/>
  </action-attrs>

  <action-record name="action-configurator-formula-record-default-type"
    model="com.axelor.apps.sale.db.ConfiguratorFormula">
    <field name="typeSelect"
      expr="eval: __parent__?.generateProduct ? __repo__(ConfiguratorFormula).TYPE_PRODUCT : __repo__(ConfiguratorFormula).TYPE_SALE_ORDER_LINE"/>
  </action-record>

  <action-record name="action-configurator-formula-record-set-show-on-configurator"
    model="com.axelor.apps.sale.db.ConfiguratorFormula">
    <field name="showOnConfigurator"
      if="typeSelect == __repo__(ConfiguratorFormula).TYPE_INFO" expr="eval: true"/>
  </action-record>

  <action-record name="action-configurator-formula-record-type-select-onchange"
    model="com.axelor.apps.sale.db.ConfiguratorFormula">
    <field name="metaField" expr="eval: null"/>
  </action-record>

  <action-attrs name="action-configurator-formula-attrs-set-meta-field-title">
    <attribute for="metaField" name="title"
      expr="eval: typeSelect == __repo__(ConfiguratorFormula).TYPE_PRODUCT ? com.axelor.i18n.I18n.get(&quot;Product field&quot;) : com.axelor.i18n.I18n.get(&quot;Sale order line field&quot;)"/>
  </action-attrs>

  <action-attrs name="action-configurator-formula-attrs-set-type-select-selection-in">
    <attribute for="typeSelect" name="selection-in" expr="eval: [3]"/>
    <attribute for="typeSelect" name="selection-in" expr="eval: [1,3]"
      if="__parent__?.generateProduct"/>
    <attribute for="typeSelect" name="selection-in" expr="eval: [2,3]"
      if="__parent__ &amp;&amp; !__parent__.generateProduct"/>
  </action-attrs>

  <action-attrs name="action-configurator-formula-attr-display-meta-json-field">
    <attribute name="hidden" for="metaJsonField"
      expr="eval:__this__?.metaField.json == false" if="eval:__this__?.metaField != null"/>
    <attribute name="value" for="metaJsonField" expr="eval:null"
      if="eval:__this__?.metaField == null || __this__?.metaField.json == false"/>
  </action-attrs>

  <action-attrs name="action-configurator-formula-attr-on-select-meta-json-field">
    <attribute name="domain" for="metaJsonField"
      if="typeSelect == __repo__(ConfiguratorFormula).TYPE_PRODUCT"
      expr="eval:&quot; self.type NOT IN ('panel', 'button', 'label', 'spacer', 'separator') AND self.model = 'com.axelor.apps.base.db.Product' AND self.modelField = '${metaField?.name}' &quot;"/>
    <attribute name="domain" for="metaJsonField"
      if="typeSelect == __repo__(ConfiguratorFormula).TYPE_PRODUCT"
      expr="eval:&quot; self.type NOT IN ('panel', 'button', 'label', 'spacer', 'separator') AND self.model = 'com.axelor.apps.sale.db.SaleOrderLine' AND self.modelField = '${metaField?.name}' &quot;"/>
  </action-attrs>

  <form name="incl-help-configurator-formula"
    model="com.axelor.apps.sale.db.ConfiguratorFormula" title="Help">
    <panel name="helpPanel" title="Help">
      <field name="$helpViewer" showTitle="false" readonly="true" colSpan="12">
        <viewer><![CDATA[
<h3 id="the-script-must-be-written-in-groovy"><span x-translate>The script must be written in</span> <a href="http://docs.groovy-lang.org/latest/html/documentation/">Groovy</a></h3>
<h4 id="string">String</h4>
<p><code>+</code> <span x-translate>is used for concatenation</span>:</p>
<pre><code>v = &quot;def&quot;
&quot;abc&quot; + v // returns &quot;abcdef&quot;</code></pre>
<p><span x-translate>String interpolation can also be used</span>:</p>
<pre><code>v = &quot;def&quot;
&quot;abc${v}&quot; // also returns &quot;abcdef&quot;</code></pre>
<h4 id="decimal">Decimal</h4>
<p><span x-translate>Standard operation like +, -, *, / can be used and will work correctly with BigDecimal.</span></p>
<h4 id="current-user" x-translate>Current User</h4>
<p><code>__user__</code> <span x-translate>gives access to connected user.</span> <br>
<span x-translate>Example: accessing the name of the user</span>: <code>__user__.name</code>.</p>
<h4 id="date">Date</h4>
<p><code>__date__</code> <span x-translate>gives access to today date and</span> <code>__datetime__</code> <span x-translate>to current date time.</span></p>
<h4 id="parentsaleorder" x-translate>Access to parent sale order</h4>
<p><code>parentSaleOrderId</code> <span x-translate>gives access to the id of parent sale order (when adding a sale order line with this configurator)</span></p>
<h4 id="query-to-database" x-translate>Query to database</h4>
<p><code>__repo__</code> <span x-translate>gives access to a repository with the same syntax as the repositories in java</span>.<br>
<span x-translate>Examples</span>:
<ul>
<li> <span x-translate>searching for Product with id = 1:</span> <code>__repo__(Product).find(1)</code>
<li> <span x-translate>searching for ProductFamily with the code ‘SERV’</span>: <code>__repo__(ProductFamily).all().filter("self.code = 'SERV'").fetchOne()</code>
<li> <span x-translate>searching Partners that are suppliers and with a name starting with “A”</span>: <code>__repo__(Partner).all().filter("self.isSupplier IS TRUE AND self.name LIKE 'A%'").fetchOne()</code>
</ul>
</p>]]>
        </viewer>
      </field>
    </panel>
  </form>

</object-views>