<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.2.xsd">

  <dashboard title="Project Dashboard" name="project.dashboard.sample" width="large"
    onInit="action.sale.chart.set.date.project">
    <search-fields>
      <field type="date" name="fromDate" title="From Date"/>
      <field type="date" name="toDate" title="To Date"/>
      <field name="project" target="com.axelor.apps.project.db.Project" title="Project"
        type="reference"/>
    </search-fields>
    <dashlet action="custom:report-table-project" height="350" canSearch="true"/>
  </dashboard>
  <custom name="report-table-project" title="Project" >
    <field name="projectTaskCategory" title="ProjectTaskCategory"
      type="com.axelor.apps.project.db.ProjectTaskCategory"/>
    <field name="ticketNumber" title="TicketNumber" type="String"
      if="__config__.app.getApp('project')?.getIsEnablePerProjectTaskSequence()"/>
    <field name="name" title="Name"/>
    <field name="status" title="Status" type="com.axelor.apps.project.db.TaskStatus"/>
    <field name="assignedTo" title="AssignedTo" type="com.axelor.auth.db.User"/>
    <field name="taskDate" title="taskDate" type="date"/>
    <field name="priority" title="Priority" type="com.axelor.apps.project.db.ProjectPriority"/>
    <field name="progress" title="Progress" type="BigDecimal" widget="Progress"/>
    <field name="budgetedTime" title="budgetedTime" type="String"/>

    <dataset type="jpql" limit="40">
      <![CDATA[

  SELECT
    pt.name AS name,
    pt.priority.name AS priority,
    pt.status.name AS status,
    pt.progress AS progress,
    pt.taskDate AS taskDate,
    pt.projectTaskCategory.name AS projectTaskCategory,
    AVG(pt.progress) AS avgProgress,
    SUM(pt.budgetedTime) AS sumBudgetedTime,
    pt.project.fullName AS project,
    pt.ticketNumber AS ticketNumber
FROM
    ProjectTask pt
JOIN
    pt.project p
WHERE
    (
        (:fromDate IS NOT NULL AND :toDate IS NOT NULL AND DATE(pt.taskDate) BETWEEN DATE(:fromDate) AND DATE(:toDate))
        OR
        (:fromDate IS NULL OR :toDate IS NULL)
    )
    AND (:project = pt.project OR :project IS NULL)
    AND p.id = pt.project.id
GROUP BY
    pt.project.fullName,
    pt.name, pt.id,
    pt.priority.name,
    pt.priority,
    pt.status.name,
    pt.status,
    pt.progress,
    pt.taskDate,
    pt.projectTaskCategory.name,
    pt.ticketNumber

ORDER BY
    pt.priority.id DESC,
    pt.status.id ASC,
    pt.progress DESC,
    pt.taskDate ASC,
    pt.id DESC

  ]]>
    </dataset>
    <template>
      <![CDATA[
  <report-table/>
  ]]>
    </template>
  </custom>

  <action-record model="com.axelor.apps.project.db.ProjectTask"
    name="action.sale.chart.set.date.project">

      <field name="toDate" expr="eval:__config__.date"/>
      <field name="fromDate" expr="eval:__config__.date.withDayOfMonth(1)"/>

  </action-record>
</object-views>
