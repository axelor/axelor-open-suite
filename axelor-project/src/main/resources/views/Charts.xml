<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.2.xsd">

  <chart name="chart.daily.planned.charge.in.month.per.project"
    title="Daily planned charge in a month per project">
    <dataset type="jpql">
  <![CDATA[
   select sum(e.hourlyRate*t.plannedTime) as charge, p.name as project
 FROM Project p
 INNER JOIN ProjectPlanningTime t ON t.project = p.id
 INNER JOIN Employee e ON t.employee = e.id
 WHERE MONTH(t.startDateTime) = MONTH(CURRENT_DATE)
 GROUP BY p.id
  ]]>
    </dataset>
    <category key="project" title="Project"/>
    <series key="charge" type="bar" title="Planned charge"/>
  </chart>

  <chart name="chart.daily.planned.charge.in.month.per.employee"
    title="Daily planned charge in a month per employee">
    <dataset type="jpql">
  <![CDATA[
   select sum(e.hourlyRate*t.plannedTime) as charge, p.name as project , e.name as employee
 FROM Project p
 INNER JOIN ProjectPlanningTime t ON t.project = p.id
 INNER JOIN Employee e ON t.employee = e.id
 WHERE MONTH(t.startDateTime) = MONTH(CURRENT_DATE)
 GROUP BY p.id,e.id
  ]]>
    </dataset>
    <category key="employee" title="Employee"/>
    <series key="charge" type="bar" title="Planned charge"/>
  </chart>

  <chart name="chart.average.daily.planned.charge.in.month.per.employee"
    title="Daily planned charge in a month in an average per employee">
    <dataset type="jpql">
  <![CDATA[
   select avg(e.hourlyRate*t.plannedTime) as charge , e.name as employee
 FROM Project p
 INNER JOIN ProjectPlanningTime t ON t.project = p.id
 INNER JOIN Employee e ON t.employee = e.id
 WHERE MONTH(t.startDateTime) = MONTH(CURRENT_DATE)
 GROUP BY e.id
  ]]>
    </dataset>
    <category key="employee" title="Employee"/>
    <series key="charge" type="bar" title="Planned charge"/>
  </chart>


  <custom name="report-table-project" title="Project">
    <field name="projectTaskCategory" title="Project task category"
      type="com.axelor.apps.project.db.ProjectTaskCategory"/>
    <field name="ticketNumber" title="Ticket number" type="String"
      if="__config__.app.getApp('project')?.getIsEnablePerProjectTaskSequence()"/>
    <field name="name" title="Name"/>
    <field name="status" title="Status" type="com.axelor.apps.project.db.TaskStatus"/>
    <field name="assignedTo" title="AssignedTo" type="com.axelor.auth.db.User"/>
    <field name="taskDate" title="taskDate" type="date"/>
    <field name="priority" title="Priority" type="com.axelor.apps.project.db.ProjectPriority"/>
    <field name="progress" title="Progress" type="BigDecimal" widget="Progress"/>
    <field name="budgetedTime" title="budgetedTime" type="String"/>

    <dataset type="jpql" limit="40">
      <![CDATA[

  SELECT
    pt.name AS name,
    pt.priority.name AS priority,
    pt.status.name AS status,
    pt.progress AS progress,
    pt.taskDate AS taskDate,
    pt.projectTaskCategory.name AS projectTaskCategory,
    AVG(pt.progress) AS avgProgress,
    SUM(pt.budgetedTime) AS sumBudgetedTime,
    pt.project.fullName AS project,
    pt.ticketNumber AS ticketNumber
FROM
    ProjectTask pt
JOIN
    pt.project p
WHERE
    (
        (:fromDate IS NOT NULL AND :toDate IS NOT NULL AND DATE(pt.taskDate) BETWEEN DATE(:fromDate) AND DATE(:toDate))
        OR
        (:fromDate IS NULL OR :toDate IS NULL)
    )
    AND (:project = pt.project OR :project IS NULL)
    AND p.id = pt.project.id
GROUP BY
    pt.project.fullName,
    pt.name, pt.id,
    pt.priority.name,
    pt.priority,
    pt.status.name,
    pt.status,
    pt.progress,
    pt.taskDate,
    pt.projectTaskCategory.name,
    pt.ticketNumber

ORDER BY
    pt.priority.id DESC,
    pt.status.id ASC,
    pt.progress DESC,
    pt.taskDate ASC,
    pt.id DESC

  ]]>
    </dataset>
    <template>
      <![CDATA[
  <report-table/>
  ]]>
    </template>
  </custom>

</object-views>
