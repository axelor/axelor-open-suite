<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_6.1.xsd">

  <grid name="calendar-event-grid" model="com.axelor.apps.base.db.ICalendarEvent"
    title="Events" orderBy="-startDateTime">
    <field name="calendar"/>
    <field name="typeSelect"/>
    <field name="user"/>
    <field name="subject"/>
    <field name="startDateTime"/>
    <field name="endDateTime"/>
    <field name="allDay"/>
  </grid>

  <grid name="calendar-event-calendar-grid" model="com.axelor.apps.base.db.ICalendarEvent"
    title="Events">
    <field name="typeSelect"/>
    <field name="user"/>
    <field name="subject"/>
    <field name="startDateTime"/>
    <field name="endDateTime"/>
    <field name="allDay"/>
  </grid>

  <grid name="icalendar-event-week-planning-grid" title="Day"
    model="com.axelor.apps.base.db.ICalendarEvent" editable="true" orderBy="sequence" canMove="true">
    <field name="subject" title="Days" readonly="true"/>
    <field name="$startTime" title="From" widget="time" x-seconds="false" type="time"
      onChange="action-ical-event-method-setDateTime-onchange"/>
    <field name="startDateTime" hidden="true"/>
    <field name="$endTime" title="To" widget="time" x-seconds="false" type="time"
      onChange="action-ical-event-method-setDateTime-onchange"/>
    <field name="endDateTime" hidden="true"/>
    <field name="recurrenceConfiguration" hidden="true"/>
    <field name="sequence" hidden="true"/>
  </grid>

  <form name="calendar-event-form" title="Event" model="com.axelor.apps.base.db.ICalendarEvent"
    onNew="action-icalendar-event-default-record" onSave="action-icalendar-event-group-on-save">
    <toolbar>
      <button name="leaveRequestBtn" title="Create Leave Request"
        onClick="save,action-ical-event-method-create-leave-request"/>
    </toolbar>
    <panel name="mainPanel">
      <field name="subject" showTitle="false" colSpan="12">
        <viewer depends="subject">
                    <![CDATA[
                        <h3>
                            <span  style="margin: 5px 0 !important; display: inline-table; line-height: initial;">{{record.subject}}</span>
                        </h3>
                    ]]>
        </viewer>
        <editor>
          <field name="subject" showTitle="true" colSpan="12"/>
        </editor>
      </field>
      <field name="startDateTime" colSpan="5"/>
      <field name="endDateTime" colSpan="5"/>
      <field name="allDay" colSpan="2"/>
      <field name="calendar"/>
      <field name="computedAttendeeList" hidden="true"/>
    </panel>
    <panel-tabs name="mainPanelTab">
      <panel title="Description" name="descriptionPanel">
        <field name="description" colSpan="12" widget="html" showTitle="false"/>
      </panel>
      <panel title="Organization" name="organizationPanel">
        <field name="geo"/>
        <field name="user"/>
        <field name="organizer"/>
        <field name="location" colSpan="12"/>
      </panel>
      <panel title="Information" name="informationPanel">
        <field name="typeSelect"/>
        <field name="visibilitySelect"/>
        <field name="disponibilitySelect"/>
        <field name="status"/>
        <field name="subjectTeam" colSpan="12"/>
      </panel>
    </panel-tabs>
    <panel name="addGuestsPanel" title="Add Guests" sidebar="true">
      <field name="$guestEmail" title="Email address" colSpan="12" type="many-to-one"
        canNew="true" onChange="action-icalendar-event-method-add-email-guest"
        target="com.axelor.message.db.EmailAddress"/>
    </panel>
    <panel name="guestsPanel" title="Guests" showIf="attendees.length != 0" colSpan="12"
      sidebar="true">
      <field name="attendees" showTitle="false" colSpan="12" canSelect="false" canNew="false">
        <editor layout="table" x-show-titles="false">
          <field name="name" readonly="true"/>
          <field name="statusSelect"/>
        </editor>
      </field>
    </panel>
    <panel sidebar="true" title="Characteristics" name="meetingAttributesPanel"
      canCollapse="true">
      <field name="recurrenceConfiguration" title="Recurrence" canNew="true" canSelect="false"
        onChange="save, action-event-method-generate-recurrence" colSpan="12"/>
    </panel>
  </form>

  <form name="icalendar-event-week-planning-form" title="Day"
    model="com.axelor.apps.base.db.ICalendarEvent">
    <panel name="mainPanel">
      <field name="subject" title="Days" readonly="true"/>
      <field name="startDateTime" title="From" widget="date-time"/>
      <field name="endDateTime" title="To" widget="date-time"/>
      <field name="recurrenceConfiguration" hidden="true"/>
    </panel>
  </form>

  <form model="com.axelor.utils.db.Wizard" title="Apply modifications"
    name="modifications-assistant-form">
    <panel name="wizardPanel">
      <button name="applyToThisBtn" title="Apply changes to this event only" onClick="close"
        colSpan="12"/>
      <button name="applyToAllBtn" title="Apply changes to all recurrence's events"
        onClick="action-icalendar-event-method-apply-changes-to-all" colSpan="12"/>
    </panel>
  </form>

  <calendar name="calendar-event-all" model="com.axelor.apps.base.db.ICalendarEvent"
    title="Calendar" eventStart="startDateTime" eventStop="endDateTime" colorBy="calendar">
    <field name="subject"/>
  </calendar>

  <calendar name="icalendar-event-week-planning-calendar"
    model="com.axelor.apps.base.db.ICalendarEvent" title="Calendar" eventStart="startDateTime"
    eventStop="endDateTime" colorBy="weeklyPlanning" editable="false">
    <field name="subject"/>
  </calendar>

  <action-view name="action-icalendar-view-ievent-dashlet" title="Events"
    model="com.axelor.apps.base.db.ICalendarEvent">
    <view type="grid" name="calendar-event-calendar-grid"/>
    <view type="form" name="calendar-event-form"/>
    <domain>self.calendar.id = :calendarId</domain>
    <context name="calendarId" expr="eval:id"/>
  </action-view>

  <action-method name="action-icalendar-event-method-add-email-guest">
    <call class="com.axelor.apps.base.web.ICalendarEventController" method="addEmailGuest"/>
  </action-method>

  <action-method name="action-icalendar-event-method-apply-changes-to-all">
    <call class="com.axelor.apps.base.web.ICalendarEventController" method="applyChangesToAll"/>
  </action-method>

  <action-method name="action-event-method-generate-recurrence">
    <call class="com.axelor.apps.base.web.ICalendarEventController"
      method="generateRecurrentEvents"/>
  </action-method>

  <action-method name="action-ical-event-method-create-leave-request">
    <call class="com.axelor.apps.hr.web.leave.LeaveController" method="createLeaveRequest"/>
  </action-method>

  <action-method name="action-ical-event-method-setDateTime-onchange">
    <call class="com.axelor.apps.base.web.weeklyplanning.WeeklyPlanningController"
      method="setDateTime"/>
  </action-method>


  <action-record name="action-icalendar-event-default-record"
    model="com.axelor.apps.base.db.ICalendarEvent">
    <field name="calendar"
      expr="eval: _calendar ?: __user__.iCalendar ?: __repo__(ICalendar).findByUser(__user__)"/>
    <field name="startDateTime"
      expr="eval: __config__.app.getTodayDateTime().truncatedTo(java.time.temporal.ChronoUnit.HOURS).plusHours(1)"
      if="!startDateTime"/>
    <field name="endDateTime"
      expr="eval: __config__.app.getTodayDateTime().truncatedTo(java.time.temporal.ChronoUnit.HOURS).plusHours(2)"
      if="!endDateTime"/>
  </action-record>

  <action-group name="action-icalendar-event-group-on-save">
    <action name="action-icalendar-event-view-modifications-recurrence"
      if="recurrenceConfiguration &amp;&amp; id > 0"/>
  </action-group>

  <action-view name="action-icalendar-event-view-modifications-recurrence"
    title="Apply modifications" model="com.axelor.utils.db.Wizard">
    <view type="form" name="modifications-assistant-form"/>
    <view-param name="popup" value="reload"/>
    <view-param name="forceEdit" value="true"/>
    <view-param name="width" value="800"/>
    <view-param name="show-toolbar" value="false"/>
    <view-param name="popup-save" value="false"/>
    <context name="_idEvent" expr="eval: id"/>
  </action-view>

</object-views>