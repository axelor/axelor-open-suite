<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.0.xsd">
  
  <form name="chart-builder-form" title="Chart builder" model="com.axelor.studio.db.ViewBuilder" width="large"
      onNew="action-view-builder-record-default" onLoad="action-chart-builder-on-load">
      <panel title="Overview">
        <field name="name"/>
        <field name="title"/>
        <field name="chartType" required="true"/>
        <field name="isJson" onChange="action-chart-builder-json-change" colSpan="2"/>
        <panel colSpan="4" itemSpan="12">
        	<field name="model" widget="ref-text" x-target="com.axelor.meta.db.MetaJsonModel" x-target-name="name" showIf="isJson"/> 
        	<field name="model" widget="ref-text" x-target="com.axelor.meta.db.MetaModel" x-target-name="fullName" showIf="!isJson"/>
        </panel> 
        <panel colSpan="6" itemSpan="12" title="Aggregate" hideIf="model == null">
        	<field name="isJsonAggregateOn" colSpan="2" />
        	<panel itemSpan="12" colSpan="10">
        		<field name="aggregateOnJson" onSelect="action-chart-builder-aggregate-on-json-select" onChange="action-chart-builder-aggregate-on-change" widget="SuggestBox" showIf="isJsonAggregateOn" />
        		<field name="aggregateOn" domain="self.metaModel.fullName = :model AND (self.typeName IN ('LocalDate','ZonedDateTime', 'LocalDateTime')  OR self.relationship = 'ManyToOne')"  onChange="action-chart-builder-aggregate-on-change" widget="SuggestBox"  showIf="!isJsonAggregateOn" />
	        </panel>
	        <field name="aggregateDateType" showIf="!isJsonAggregateOn &amp;&amp; ['LocalDateTime','LocalDate','ZonedDateTime'].indexOf(aggregateOn.typeName) > -1 || isJsonAggregateOn &amp;&amp; ['date','datetime'].indexOf(aggregateOnJson.type) > -1" requiredIf="!isJsonAggregateOn &amp;&amp; ['LocalDateTime','LocalDate','ZonedDateTime'].indexOf(aggregateOn.typeName) > -1 || isJsonAggregateOn &amp;&amp; ['date','datetime'].indexOf(aggregateOnJson.type) > -1" />
       		<field name="aggregateOnTarget" title="Target" showIf="!isJsonAggregateOn &amp;&amp; aggregateOn.relationship != null || isJsonAggregateOn &amp;&amp; (aggregateOnJson.targetModel != null || aggregateOnJson.targetJsonModel != null)" requiredIf="!isJsonAggregateOn &amp;&amp; aggregateOn.relationship != null || isJsonAggregateOn &amp;&amp; (aggregateOnJson.targetModel != null || aggregateOnJson.targetJsonModel != null)" />
        </panel>
        <panel colSpan="6" itemSpan="12" title="Group" hideIf="model == null">
        	<field name="isJsonGroupOn" colSpan="2" />
        	<panel itemSpan="12" colSpan="10">
        		<field name="groupOnJson" onSelect="action-chart-builder-group-on-json-select"  widget="SuggestBox" onChange="action-chart-builder-group-on-change" showIf="isJsonGroupOn" />
        		<field name="groupOn" requiredIf="!isJsonGroupOn" domain="self.metaModel.fullName = :model AND (self.typeName IN ('LocalDate','ZonedDateTime', 'LocalDateTime')  OR self.relationship = 'ManyToOne')" onChange="action-chart-builder-group-on-change" widget="SuggestBox" showIf="!isJsonGroupOn" />
        	</panel>
        	<field name="groupDateType" showIf="!isJsonGroupOn &amp;&amp; ['LocalDateTime','LocalDate','ZonedDateTime'].indexOf(groupOn.typeName) > -1 || isJsonGroupOn &amp;&amp; ['date','datetime'].indexOf(groupOnJson.type) > -1" requiredIf="!isJsonGroupOn &amp;&amp; ['LocalDateTime','LocalDate','ZonedDateTime'].indexOf(groupOn.typeName) > -1 || isJsonGroupOn &amp;&amp; ['date','datetime'].indexOf(groupOnJson.type) > -1" />
        	<field name="groupOnTarget" title="Target" showIf="!isJsonGroupOn &amp;&amp; groupOn.relationship != null || isJsonGroupOn &amp;&amp; (groupOnJson.targetModel != null || groupOnJson.targetJsonModel != null)" requiredIf="!isJsonGroupOn &amp;&amp; groupOn.relationship != null || isJsonGroupOn &amp;&amp; (groupOnJson.targetModel != null || groupOnJson.targetJsonModel != null)" />
        </panel>
        <panel colSpan="6" title="Display" itemSpan="12" hideIf="model == null">
	        <field name="isJsonDisplayField" colSpan="2"/>
	        <panel itemSpan="12" colSpan="10">
	          <field name="displayFieldJson" requiredIf="isJsonDisplayField" onSelect="action-chart-builder-display-field-json-field" widget="SuggestBox"  showIf="isJsonDisplayField"/>
	       	  <field name="displayField" requiredIf="!isJsonDisplayField" domain="self.metaModel.fullName = :model AND self.typeName IN ('Integer','BigDecimal')" widget="SuggestBox" showIf="!isJsonDisplayField"/>
        	</panel>
        	<field name="aggregateOn.typeName" hidden="true" />  
        </panel>
        <field name="groupOn.typeName" hidden="true" />
        <field name="aggregateOn.relationship" hidden="true" />
        <field name="groupOn.relationship" hidden="true" />
        <field name="aggregateOnJson.targetModel" hidden="true" />
        <field name="aggregateOnJson.type" hidden="true" />
        <field name="aggregateOnJson.targetJsonModel" hidden="true" />
        <field name="groupOnJson.targetModel" hidden="true" />
        <field name="groupOnJson.targetJsonModel" hidden="true" />
        <field name="groupOnJson.type" hidden="true" />
        <field name="viewType" hidden="true" />
       </panel>
      <panel hideIf="model == null">
      	  <label title="&lt;b&gt;Tags:&lt;/b&gt; $user: Current user, $date: Today's date, $time: Current time" colSpan="12" />
      	  <panel-related field="filterList" colSpan="12" editable="true" edit-window="blank" />
      </panel>
  </form>
  
  <action-attrs name="action-chart-builder-aggregate-on-json-select">
  	<attribute name="domain" for="aggregateOnJson" expr="eval:&quot;self.jsonModel.name = '${model}' AND self.type IN ('datetime','date','many-to-one','json-many-to-one')&quot;"/>
  </action-attrs>
  
  <action-attrs name="action-chart-builder-group-on-json-select">
  	<attribute name="domain" for="groupOnJson" expr="eval:&quot;self.jsonModel.name = '${model}' AND self.type IN ('datetime','date','many-to-one','json-many-to-one')&quot;"/>
  </action-attrs>
  
  <action-attrs name="action-chart-builder-display-field-json-field">
  	<attribute name="domain" for="displayFieldJson" expr="eval:&quot;self.jsonModel.name = '${model}' AND self.type IN ('integer','decimal')&quot;"/>
  </action-attrs>
  
  <action-attrs name="action-chart-builder-json-change">
  	<attribute name="value" for="model" expr="eval:null"/>
  	<attribute name="value" for="isJsonAggregateOn" expr="eval:isJson"/>
  	<attribute name="value" for="isJsonGroupOn" expr="eval:isJson"/>
  	<attribute name="value" for="isJsonDisplayField" expr="eval:isJson"/>
  	<attribute name="hidden" for="isJsonAggregateOn" expr="eval:isJson" />
  	<attribute name="hidden" for="isJsonGroupOn" expr="eval:isJson" />
  	<attribute name="hidden" for="isJsonDisplayField" expr="eval:isJson" />
  	<attribute name="value" for="filterList.isJson" expr="eval:isJson"/>
  	<attribute name="hidden" for="filterList.isJson" expr="eval:isJson"/>
  	<attribute name="hidden" for="filterList.metaField"  expr="eval:isJson"/>
  </action-attrs>
  
  <action-attrs name="action-chart-builder-on-load">
  	<attribute name="hidden" for="isJsonAggregateOn" expr="eval:isJson" />
  	<attribute name="hidden" for="isJsonGroupOn" expr="eval:isJson" />
  	<attribute name="hidden" for="isJsonDisplayField" expr="eval:isJson" />
  	<attribute name="hidden" for="filterList.isJson" expr="eval:isJson"/>
  	<attribute name="hidden" for="filterList.metaField"  expr="eval:isJson"/>
  </action-attrs>
  
  <action-record name="action-chart-builder-aggregate-on-change" model="com.axelor.studio.db.ViewBuilder">
  	<field name="aggregateOnTarget" expr="call:com.axelor.studio.web.ChartBuilderController:getTarget(aggregateOn)" if="!isJsonAggregateOn"/>
  	<field name="aggregateOnTarget" expr="call:com.axelor.studio.web.ChartBuilderController:getTarget(aggregateOnJson)" if="isJsonAggregateOn"/>
  </action-record>
  
  <action-record name="action-chart-builder-group-on-change" model="com.axelor.studio.db.ViewBuilder">
  	<field name="groupOnTarget" expr="call:com.axelor.studio.service.builder.ChartBuilderService:getDefaultTarget(groupOn)" if="!isJsonGroupOn"/>
  	<field name="groupOnTarget" expr="call:com.axelor.studio.service.builder.ChartBuilderService:getDefaultTarget(groupOnJson)" if="isJsonGroupOn"/>
  </action-record>
  
  <action-record name="action-view-builder-record-default" model="com.axelor.studio.db.ViewBuilder">
  	<field name="viewType" expr="eval:_viewType"/>
  </action-record>
  
</object-views>


