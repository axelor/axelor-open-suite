<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.2.xsd">

  <grid model="com.axelor.apps.hr.db.TimesheetLine" title="Timesheet lines"
    name="quick-timesheet-line-grid" orderBy="date" groupBy="date">

    <toolbar>
      <button name="createBtn" title="New line" icon="fa-plus"
        onClick="action-quick-timesheet-view-new-line"/>
      <button name="removeBtn" title="Remove lines" icon="fa-trash"
        onClick="action-timesheet-line-method-remove-timesheet-lines"/>
    </toolbar>

    <field name="project" width="200"/>
    <field name="projectTask" width="350"/>
    <field name="date" width="150"/>
    <field name="duration" aggregate="sum" width="100"/>
    <field name="comments" width="500"/>

  </grid>

  <grid model="com.axelor.apps.project.db.ProjectTask" title="Tasks"
    name="project-task-quick-timesheet-grid">

    <field name="name"/>
    <field name="ticketNumber"
      if="__config__.app.getApp('project')?.getIsEnablePerProjectTaskSequence()"/>
    <field name="project"/>
    <button onClick="action-quick-timesheet-view-new-line" name="logBtn" icon="clock-history"/>

  </grid>

  <form model="com.axelor.apps.hr.db.TimesheetLine" title="Timesheet line"
    name="quick-timesheet-line-form"
    onNew="action-quick-timesheet-line-attrs-on-new,action-timesheet-line-attrs-set-duration-label"
    onLoad="action-timesheet-line-attrs-set-duration-label">

    <panel name="mainPanel">
      <field name="project" onSelect="action-timesheet-line-attrs-domain-project"/>
      <field name="projectTask" onSelect="action-timesheet-line-attrs-domain-project-task"/>
      <field name="date"
        onChange="action-quick-timesheet-line-validate-date,action-timesheet-line-method-check-daily-limit"/>
      <field name="duration" onChange="action-timesheet-line-method-set-stored-duration"
        colSpan="5"/>
      <label name="durationLabel" colSpan="1"/>
      <field name="comments" colSpan="12"/>
    </panel>

  </form>

  <form name="quick-timesheet-form" title="Timesheet" model="com.axelor.utils.db.Wizard"
    onNew="action-quick-timesheet-group-on-new" width="large">

    <panel name="mainPanel" colSpan="12">
      <field name="user" title="User" type="many-to-one" target="com.axelor.auth.db.User"
        onChange="action-quick-timesheet-group-user-on-change" x-dirty="false"/>
      <field name="user.employee" hidden="true"/>
    </panel>
    <panel name="timesheetPanel" title="Timesheet" readonly="true" showIf="user?.employee">
      <field name="timesheet" title="Timesheet" type="many-to-one"
        target="com.axelor.apps.hr.db.Timesheet" form-view="timesheet-form" x-dirty="false"
        colSpan="3"/>
      <field name="fromDate" title="From" type="date" x-dirty="false" colSpan="3"/>
      <field name="toDate" title="To" type="date" x-dirty="false" colSpan="3"/>
      <field name="timeLoggingPreferenceSelect" title="Time unit" type="string"
        selection="hr.time.logging.preference.select" x-dirty="false" colSpan="3"/>
    </panel>
    <panel name="openProjectTaskPanel" title="Open tasks" showIf="user?.employee"
      collapseIf="true">
      <panel-dashlet name="projectTaskPanel"
        action="action-quick-timesheet-method-view-tasks" readonly="true" colSpan="12" height="200%"/>
    </panel>
    <panel-dashlet name="quickTimesheetLinesPanel"
      action="action-quick-timesheet-method-view-lines" title="Timesheet lines" x-show-bars="true"
      showIf="user?.employee" height="200%"/>
    <panel name="totalsPanel" title="Totals on period" readonly="true" showIf="user?.employee">
      <field name="totalTimeEntriesForPeriod" title="Total time entries" type="decimal"
        x-dirty="false" colSpan="4"/>
      <field name="totalLeavesAndHolidaysForPeriod" title="Total leaves and public holidays"
        type="decimal" x-dirty="false" colSpan="4"/>
      <field name="totalDueTimeEntriesForPeriod" title="Total due time entries" type="decimal"
        x-dirty="false" colSpan="4"/>
    </panel>

  </form>

  <action-view name="action-quick-timesheet-view-new-line" title="Timesheet line"
    model="com.axelor.apps.hr.db.TimesheetLine">
    <view type="form" name="quick-timesheet-line-form"/>
    <view-param name="popup" value="reload"/>
    <view-param name="popup-save" value="true"/>
    <view-param name="forceEdit" value="true"/>
    <view-param name="show-toolbar" value="false"/>
    <context name="_timesheet" expr="eval: __parent__?.timesheet"/>
    <context name="_employee" expr="eval: __parent__?.user?.employee"/>
    <context name="_fromDate" expr="eval: __parent__?.fromDate"/>
    <context name="_toDate" expr="eval: __parent__?.toDate"/>
    <context name="_projectTask" expr="eval: __self__" if="__id__"/>
    <context name="_project" expr="eval: __self__?.project" if="__id__"/>
  </action-view>

  <action-attrs name="action-quick-timesheet-attrs-refresh-panel-dashlets">
    <attribute name="refresh" for="quickTimesheetLinesPanel" expr="eval: true"/>
    <attribute name="refresh" for="projectTaskPanel" expr="eval: true"/>
  </action-attrs>

  <action-attrs name="action-quick-timesheet-line-attrs-on-new">
    <attribute name="value" for="timesheet" expr="eval: _timesheet"/>
    <attribute name="value" for="employee" expr="eval: _employee"/>
    <attribute name="value" for="date" expr="eval: __date__"/>
    <attribute name="value" for="projectTask" expr="eval: _projectTask"/>
    <attribute name="value" for="project" expr="eval: _project"/>
  </action-attrs>

  <action-attrs name="action-quick-timesheet-attrs-on-new">
    <attribute name="value" for="user" expr="eval: __user__"/>
    <attribute name="value" for="date" expr="eval: __date__"/>
  </action-attrs>

  <action-method name="action-quick-timesheet-method-compute-timesheet">
    <call class="com.axelor.apps.hr.web.timesheet.QuickTimesheetController"
      method="computeTimesheet"/>
  </action-method>

  <action-method name="action-quick-timesheet-method-view-lines">
    <call class="com.axelor.apps.hr.web.timesheet.QuickTimesheetController" method="viewLines"/>
  </action-method>

  <action-method name="action-quick-timesheet-method-compute-totals">
    <call class="com.axelor.apps.hr.web.timesheet.QuickTimesheetController"
      method="computeTotals"/>
  </action-method>

  <action-method name="action-quick-timesheet-method-new-line">
    <call class="com.axelor.apps.hr.web.timesheet.QuickTimesheetController" method="newLine"/>
  </action-method>

  <action-method name="action-quick-timesheet-method-view-tasks">
    <call class="com.axelor.apps.hr.web.timesheet.QuickTimesheetController" method="viewTasks"/>
  </action-method>

  <action-validate name="action-quick-timesheet-line-validate-date">
    <error message="This date is invalid. It must be included in the timesheet's period."
      if="date != null &amp;&amp; ((_toDate != null &amp;&amp; date &gt; LocalDate.parse(_toDate)) || (_fromDate != null &amp;&amp; date &lt; LocalDate.parse(_fromDate)))"
      action="action-timesheet-line-null-date"/>
  </action-validate>

  <action-group name="action-quick-timesheet-group-user-on-change">
    <action name="action-quick-timesheet-method-compute-timesheet"/>
    <action name="action-quick-timesheet-method-compute-totals"/>
    <action name="action-quick-timesheet-attrs-refresh-panel-dashlets"/>
  </action-group>

  <action-group name="action-quick-timesheet-group-on-new">
    <action name="action-quick-timesheet-attrs-on-new"/>
    <action name="action-quick-timesheet-group-user-on-change"/>
  </action-group>

</object-views>
