<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.4.xsd">

  <form name="sale-order-form" title="Sale order" model="com.axelor.apps.sale.db.SaleOrder"
    id="business-project-sale-order-form" extension="true">

    <extend target="//panel[@name='productionPanel']">
      <insert position="after">
        <panel name="businessProjectPanel" title="Business project"
          if="__config__.app.isApp('business-project') &amp;&amp; __config__.app.getApp('business-project').getGenerateProjectOrder()">
          <field name="project" canEdit="false" domain="self.clientPartner = :clientPartner"
            form-view="business-project-form" grid-view="project-grid" edit-window="blank"
            onChange="action-business-project-sale-order-method-update-lines"/>
          <field name="contract" readonly="true" hidden="true" showIf="contract"
            form-view="contract-form" grid-view="contract-grid"/>

          <panel name="projectAndTaskGenerationPanel" title="Project and task generation"
            colSpan="12">
            <field name="$_projectGeneratorType" title="Project generation method"
              x-enum-type="com.axelor.apps.project.db.ProjectGeneratorType"
              help="You can either generate an empty project, a project with sub-projects or a project with tasks. When generating sub-projects or tasks, one element will be created for each sale order line with a service-type product that has &quot;Produce&quot; as its supply method (Configuration tab). Subtasks models are filled in the Product form when the corresponding configuration is active in Business Project module configuration."/>
            <field name="$_elementStartDate" title="Start date" widget="date-time"
              type="datetime" colSpan="3"/>
            <field name="$projectTemplate" domain="self.company = :company"
              showIf="$_projectGeneratorType &amp;&amp; $_projectGeneratorType == 'PROJECT_ALONE' &amp;&amp; project == null"
              colSpan="3" type="many-to-one" target="com.axelor.apps.project.db.ProjectTemplate"
              title="Project template"/>
            <panel name="fillOrGenerateProjectPanel" stacked="true">
              <button name="generateProjectBtn" readonlyIf="!$_projectGeneratorType"
                title="Generate Project/Business"
                if="!__config__.app.getApp('business-project').automaticProject"
                showIf="project == null" hidden="true"
                onClick="save,action-business-project-method-generate-project"/>
              <button name="fillProjectBtn" readonlyIf="!$_projectGeneratorType"
                title="Fill project"
                if="__config__.app.getApp('business-project').projectSaleOrderLines"
                showIf="project != null" hidden="true"
                onClick="save,action-business-project-method-fill-project"/>
            </panel>

          </panel>
        </panel>
      </insert>
    </extend>
  </form>

  <form name="sale-order-template-form" title="Template"
    model="com.axelor.apps.sale.db.SaleOrder" id="business-project-sale-order-template-form"
    extension="true">
    <extend target="/">
      <attribute name="onNew"
        value="action-sale-order-method-onnew,action-saleorder-record-template,action-sale-order-method-create-template"/>
    </extend>

    <extend target="//panel[@name='otherInformationsPanel']">
      <insert position="after">
        <panel name="projectPanel"
          if="__config__.app.isApp('business-project') &amp;&amp; __config__.app.getApp('business-project').getGenerateProjectOrder()"
          title="Business project" colSpan="12" if-module="axelor-business-project">
          <field name="project" form-view="business-project-form" grid-view="project-grid"
            colSpan="12"/>
        </panel>
      </insert>
    </extend>
  </form>

  <form name="sale-order-generate-po-select-supplierpartner-form"
    id="business-project-sale-order-generate-po-select-supplierpartner-form"
    model="com.axelor.apps.sale.db.SaleOrder" title="Confirm Purchase order generation"
    onLoad="action-record-load-dummy-supplier-partner" extension="true">
    <extend target="//button[@name='generatePOConfirmBtn']">
      <attribute name="onClick"
        value="action-sale-order-group-generate-po-select-supplierpartner-from-project-task"/>
    </extend>
  </form>

  <action-group
    name="action-sale-order-group-generate-po-select-supplierpartner-from-project-task">
    <action name="action-supplychain-so-generate-po-check-supplier-partner"/>
    <action
      name="action-supplychain-sale-order-generate-purchase-orders-from-selected-SOLines"
      if="eval: !_projectTaskId"/>
    <action name="action-project-task-method-generate-purchase-order"
      if="eval: _projectTaskId"/>
  </action-group>

  <action-method
    name="action-business-project-sale-order-method-generate-invoicing-project">
    <call class="com.axelor.apps.businessproject.web.SaleOrderProjectController"
      method="generateInvoicingProject"/>
  </action-method>

  <action-condition name="action-business-project-sale-order-condition-invoicing">
    <check error="A deadline is required" field="deadline" if="!deadline"/>
  </action-condition>

  <action-method name="action-business-project-method-generate-project">
    <call class="com.axelor.apps.businessproject.web.SaleOrderProjectController"
      method="generateProject"/>
  </action-method>

  <action-method name="action-business-project-method-fill-project">
    <call class="com.axelor.apps.businessproject.web.SaleOrderProjectController"
      method="fillProject"/>
  </action-method>

  <action-method name="action-business-project-sale-order-method-update-lines">
    <call class="com.axelor.apps.businessproject.web.SaleOrderProjectController"
      method="updateLines"/>
  </action-method>

  <action-attrs name="action-sale-order-record-project-default-fields"
    if-module="axelor-business-project">
    <attribute for="$_elementStartDate" name="value" expr="#{__datetime__}"/>
  </action-attrs>

  <action-attrs name="action-sale-order-attrs-set-required">
    <attribute name="required" for="$_projectGeneratorType"
      expr="eval: statusSelect == com.axelor.apps.sale.db.repo.SaleOrderRepository.STATUS_FINALIZED_QUOTATION &amp;&amp; __config__.app.getApp('business-project')?.getAutomaticProject()"/>
  </action-attrs>

  <action-attrs
    name="action-sale-order-attrs-hide-selection-on-enable-task-template-by-product">
    <attribute name="selection-in" for="$_projectGeneratorType"
      if="!__config__.app.getApp('business-project')?.getEnableTaskTemplatesByProduct()"
      expr="['PROJECT_ALONE', 'SUB_PROJECT_BY_LINE', 'TASK_BY_LINE']"/>
  </action-attrs>

  <action-group id="business-project-action-group-sale-saleorder-onload"
    name="action-group-sale-saleorder-onload">
    <action name="action-sale-order-method-onload"/>
    <action name="action-sale-order-attrs-collapse-specific-settings-group"/>
    <action name="action-sale-order-attrs-in-ati"/>
    <action name="action-sale-order-attrs-hidden-bank-details"/>
    <action name="action-sale-order-record-project-default-fields"
      if="__config__.app.isApp('business-project')"/>
    <action name="action-sale-order-attrs-external-reference"/>
    <action name="action-sale-order-attrs-availability"/>
    <action name="action-sale-order-attrs-set-required"/>
    <action name="action-sale-order-attrs-set-discounts-need-review"/>
    <action name="action-sale-order-record-get-trading-names-management-config"/>
    <action name="action-sale-order-method-is-incoterm-required"/>
    <action name="action-sale-order-attrs-hide-selection-on-enable-task-template-by-product"/>
    <action name="action-sale-order-method-get-last-version"/>
    <action name="action-sale-order-attrs-set-save-actual-version"/>
    <action name="action-sale-order-attrs-list-selection-in-type-select"/>
  </action-group>

  <action-group id="business-project-action-sale-group-confirmed"
    name="action-sale-group-confirmed">
    <action name="action-sale-order-method-check-before-confirm"/>
    <action name="action-sale-order-method-fill-incoterm-if-required"
      if="!incoterm &amp;&amp; __config__.app.getApp('stock')?.isIncotermEnabled"/>
    <action name="save"/>
    <action name="action-business-project-method-generate-project"
      if="__config__.app.isApp('business-project') &amp;&amp; __config__.app.getApp('business-project').getAutomaticProject()"/>
    <action name="action-sale-order-method-confirm"/>
  </action-group>

  <search-filters id="business-project-sale-order-filters" name="sale-order-filters"
    model="com.axelor.apps.sale.db.SaleOrder" title="Sales Order filters">
    <field name="company" hidden="true"
      if="!__config__.app.getApp('base')?.getEnableMultiCompany()"/>
    <field name="tradingName" hidden="true"
      if="!__config__.app.getApp('base')?.enableTradingNamesManagement"/>
    <field name="saleOrderTypeSelect" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.getAllowSusbcriptionSaleOrder())"/>
    <field name="versionNumber" hidden="true"
      if="!__config__.app.getApp('sale')?.getManageSaleOrderVersion()"/>
    <field name="project" hidden="true"
      if="!(__config__.app.isApp('business-project') &amp;&amp; __config__.app.getApp('business-project').getGenerateProjectOrder())"/>
    <field name="timetableTemplate" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.getAllowTimetableInvoicing())"/>
    <field name="computationDate" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.getAllowTimetableInvoicing())"/>
    <field name="timetableList" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.getAllowTimetableInvoicing())"/>
    <field name="amountToBeSpreadOverTheTimetable" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.getAllowTimetableInvoicing())"/>
    <field name="advancePaymentList" hidden="true"
      if="!(__config__.app.isApp('account') &amp;&amp; !__config__.app.getApp('account')?.getManageAdvancePaymentInvoice())"/>
    <field name="advancePaymentNeeded" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.manageAdvancePaymentsFromPaymentConditions)"/>
    <field name="advancePaymentAmountNeeded" hidden="true"
      if="!(__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.manageAdvancePaymentsFromPaymentConditions)"/>
    <field name="printingSettings" hidden="true"
      if="!__config__.app.getApp('sale')?.getPrintingConfigPerSaleOrder()"/>
    <field name="hideDiscount" hidden="true"
      if="!__config__.app.getApp('sale')?.getPrintingConfigPerSaleOrder()"/>
    <field name="specificNotes" hidden="true"
      if="!__config__.app.getApp('sale')?.getPrintingConfigPerSaleOrder()"/>
    <field name="team" hidden="true" if="!__config__.app.getApp('base')?.getTeamManagement()"/>
    <field name="expectedRealisationDate" hidden="true"
      if="!__config__.app.isApp('supplychain') &amp;&amp; __config__.app.getApp('supplychain')?.getAllowTimetableInvoicing()"/>
    <field name="stockLocation" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="toStockLocation" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="amountInvoiced" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="deliveryState" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="directOrderLocation" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="interco" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="createdByInterco" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="specificPackage" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="estimatedShippingDate" hidden="true"
      if="!__config__.app.isApp('supplychain')"/>
    <field name="deliveryCondition" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="shipmentMode" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="freightCarrierMode" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="carrierPartner" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="forwarderPartner" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="incoterm" hidden="true"
      if="!__config__.app.isApp('supplychain') || !__config__.app.getApp('stock')?.isIncotermEnabled"/>
    <field name="isNeedingConformityCertificate" hidden="true"
      if="!__config__.app.isApp('supplychain')"/>
    <field name="isIspmRequired" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="deliveryComments" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="pickingOrderComments" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="productionNote" hidden="true" if="!__config__.app.isApp('production')"/>
    <field name="paymentMode" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="paymentCondition" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="shipmentDate" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="standardDelay" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="invoicingState" hidden="true" if="!__config__.app.isApp('supplychain')"/>
    <field name="saleOrderLineList.product.name" title="Product Name"/>
    <field name="companyExTaxTotal" title="Total W.T. in company currency"/>
    <field name="cancelReason" hidden="true"/>
    <field name="deliveryAddress" hidden="true"/>
    <field name="mainInvoicingAddress" hidden="true"/>
    <filter name="sale-order-filters-my-proposals" title="My Proposals">
      <domain>(self.statusSelect = 1 or self.statusSelect = 2) and self.salespersonUser.id =
        :_internalUser</domain>
    </filter>
    <filter name="sale-order-filters-my-sales" title="My Sales">
      <domain>self.statusSelect = 3 and self.salespersonUser.id = :_internalUser</domain>
    </filter>
    <filter name="sale-order-filters-my-team-proposals" title="My Team Proposals">
      <domain>(self.statusSelect = 1 or self.statusSelect = 2) and self.team = :_myActiveTeam</domain>
    </filter>
    <filter name="sale-order-filters-my-team-sales" title="My Team Sales">
      <domain>self.statusSelect = 3 and self.team = :_myActiveTeam</domain>
    </filter>
  </search-filters>

</object-views>