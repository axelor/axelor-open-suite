<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.4.xsd">

  <!-- Grid View -->
  <grid name="task-report-grid" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport" canEdit="false" editable="false">
    <toolbar>
      <button name="addNewTaskReport" title="New Task Report" css="btn-custom text-left"
        icon="fa-plus" onClick="action-task-report-new"/>
    </toolbar>
    <field name="project" title="Order "/>
    <field name="customer.simpleFullName" title="Customer"/>
    <field name="taskDate" title="Date"/>
    <field name="location"/>
    <field name="totalWorkHours"/>
  </grid>
  <!-- Grid View for TaskMemberReport -->
  <grid name="task-member-report-grid" title="Team Members' Reports"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="employee" title="Employee"/>
    <field name="task" title="Task"/>
    <field name="taskCategories" widget="TagSelect"/>
    <field name="startTime" title="Start Time"/>
    <field name="breakTimeHours" title="Break Time (hours)"/>
    <field name="endTime" title="End Time"/>
    <field name="workHours" title="Work Hours (hours)"/>
  </grid>

  <!-- Form View -->
  <form name="task-report-form" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport" onNew="action-task-report-default"
    width="large">
    <panel colSpan="12" name="parentPanel" showFrame="true">
      <panel title="General Information" showFrame="false">
        <field name="project" title="Order"
          domain="self.membersUserSet.id = :__user__ OR self.assignedTo.id = :__user__"
          onChange="action-task-report-on-change-project" required="true"/>
        <field name="customer" hidden="true"/>
        <field name="customer"/>
        <field name="location" canEdit="true"/>
      </panel>

      <!-- Panel for Task Member Reports -->
      <panel title="Team Members Reports" canCollapse="true" collapseIf="true" colSpan="12">
        <field name="taskMemberReports" widget="list" colSpan="12"
               canNew="true" canEdit="true"
               form-view="task-member-report-form"
          onChange="action-update-total-work-hours"/>
        <panel>
          <field name="totalWorkHours"/>
        </panel>
      </panel>
      <panel title="Team Lead Reports" canCollapse="true" collapseIf="true" colSpan="12">
        <field name="taskMemberReports" widget="list" colSpan="12"
               form-view="task-member-report-form-lead" canNew="true" canEdit="true"
          onChange="action-update-total-work-hours"/>
        <panel>
          <field name="totalWorkHours"/>
        </panel>
      </panel>

      <panel colSpan="12" showFrame="false">
        <panel title="Extra charges" colSpan="6" showFrame="true">
          <field name="travelExpenses" colSpan="6" widget="checkbox"/>
          <field name="toolsUsage" colSpan="6" widget="checkbox"/>
        </panel>
        <panel title="Additional Services" colSpan="6" showFrame="true">
          <field name="additionalServices" colSpan="12" widget="MultiSelect"/>
        </panel>
        <panel title="Activity Details" colSpan="12" showTitle="false">
          <field name="material" colSpan="12" widget="textarea"/>
          <field name="otherServices" colSpan="12" widget="textarea"/>
          <field name="comments" title="Comments" colSpan="12" widget="textarea"/>
        </panel>
      </panel>

      <panel title="Sign-Off" showFrame="false">
        <panel colSpan="12">
          <field name="taskDate" colSpan="4"/>
        </panel>
        <panel colSpan="12">
          <field name="employee" title="Employee Name"/>
          <field name="customerName" title="Customer Name" readonly="false"/>

          <field name="employeeSignature" title="Employee Signature" widget="drawing"
            colSpan="6"/>
          <field name="customerSignature" title="Customer Signature" widget="drawing"
            readonly="false" colSpan="6"/>
        </panel>
      </panel>
      <panel colSpan="12" showFrame="false">
        <button name="btnPreviewTaskReport" title="Preview" icon="fa-eye" colSpan="12"
          onClick="save, action-task-report-method-preview-for-customer"/>
      </panel>
    </panel>
  </form>

  <!-- Define the form view for Task Member Report -->
  <form name="task-member-report-form" title="Team Member Report"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <panel colSpan="12" canCollapse="true" collapseIf="false">
      <field name="task" title="Task" widget="Select"
        domain-function="eval: 'self.project.id = ' + parent.project.id"
        onChange="action-task-member-report-on-change-task"/>
      <field name="employee" title="Employee"/>
      <field name="startTime" onChange="action-task-report-on-change-time"/>
      <field name="breakTimeHours" onChange="action-task-report-on-change-time"/>
      <field name="endTime" onChange="action-task-report-on-change-time"/>
      <field name="task.projectTaskCategory" title="Task Category" readonly="true"/>
      <field name="workHours"/>
    </panel>
  </form>
  <form name="task-member-report-form-lead" title="Team Lead Member Report"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <panel colSpan="12" canCollapse="true" collapseIf="false">
      <field name="employee" title="Employee" domain-function="eval: project?.membersUserSet"/>
      <field name="task" title="Task" widget="Select" colSpan="12"
        domain-function="eval: 'self.project.id = ' + parent.project.id + ' AND self.assignedTo.id = ' + parent.employee.id"/>
      <field name="startTime" onChange="action-task-report-on-change-time"/>
      <field name="breakTimeHours" onChange="action-task-report-on-change-time"/>
      <field name="endTime" onChange="action-task-report-on-change-time"/>
      <field name="task.projectTaskCategory" title="Task Category" readonly="true"/>
      <field name="workHours"/>
    </panel>
  </form>

  <action-method name="action-task-report-method-print">
    <call class="com.axelor.apps.businessproject.web.TaskReportController"
      method="printTaskReport"/>
  </action-method>

  <!-- Action when project changes - auto-fill all related fields -->
  <action-record name="action-task-report-on-change-project"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <field name="customer" expr="eval: project?.clientPartner"/>
    <field name="customerName" expr="eval: project?.contactPartner"/>
    <field name="location" expr="eval: project?.customerAddress"/>
  </action-record>

  <action-record name="action-task-member-report-on-change-task"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="employee" expr="eval: task?.assignedTo"/>
  </action-record>

  <action-view name="action-task-report-dashlet" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <view type="grid" name="task-report-grid"/>
    <view type="form" name="task-report-form"/>
    <domain>
      self.project != null
      AND self.project.id = :projectId
      AND :__user__ MEMBER OF
      self.project.membersUserSet
    </domain>
    <context name="project" expr="eval:__parent__"/>
  </action-view>

  <action-view name="member-task-report" title="Member Task Reports"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <view type="form" name="task-member-report-form"/>
    <view-param name="popup" value="reload"/>
    <context name="employee" expr="eval: project?.membersUserSet"/>
    <context name="project" expr="eval: __parent__.project"/>
  </action-view>
  <action-view name="member-task-report-lead" title="Member Task Reports"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <view type="form" name="task-member-report-form-lead"/>
    <view-param name="popup" value="reload"/>
    <context name="employee" expr="eval: project?.membersUserSet"/>
    <context name="project" expr="eval: __parent__.project"/>
  </action-view>

  <action-record name="action-task-report-on-change-time"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="workHours"
      expr="eval: (startTime != null &amp;&amp; endTime != null) ? ( (java.time.Duration.between(startTime.toLocalTime(), endTime.toLocalTime()).toMinutes() / 60.0) - (breakTimeHours ?: 0) ) : 0"/>
  </action-record>
  <action-record name="action-update-total-work-hours"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <field name="totalWorkHours"
      expr="eval: (taskMemberReports != null) ? taskMemberReports.stream().filter(r -> r.workHours != null).map(r -> r.workHours)
          .reduce(java.math.BigDecimal.ZERO, java.math.BigDecimal::add) : 0"/>
  </action-record>

</object-views>