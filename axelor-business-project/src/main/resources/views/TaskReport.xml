<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.4.xsd">

  <!-- Grid View -->
  <grid name="task-report-grid" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport" canEdit="true" canNew="true"
    canArchive="true" canDelete="true" onNew="action-business-project-add-task-report">
    <field name="project" title="Order"/>
    <field name="customer.simpleFullName" title="Customer"/>
    <field name="taskDate" title="Date"/>
    <field name="location"/>
    <field name="totalWorkHours"/>
  </grid>
  <grid name="add-task-report-grid" title="Task Reports" canDelete="true" canNew="false"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <toolbar>
      <button name="addNewTaskReport" title="New Task Report" css="btn-custom text-left"
        icon="fa-plus" onClick="action-business-project-add-task-report"/>
    </toolbar>
    <field name="project" title="Order "/>
    <field name="customer.simpleFullName" title="Customer"/>
    <field name="taskDate" title="Date"/>
    <field name="location"/>
    <field name="totalWorkHours"/>
  </grid>
  <!-- Grid View for TaskMemberReport -->
  <grid name="task-member-report-grid" title="Team Members' Reports" canDelete="true"
    canEdit="true" canNew="true" model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="employee" title="Employee"/>
    <field name="task" title="Task"/>
    <field name="taskCategories" widget="TagSelect"/>
    <field name="startTime" title="Start Time"/>
    <field name="breakTimeMinutes" title="Break Time (min)"/>
    <field name="endTime" title="End Time"/>
    <field name="workHours" title="Work Hours (hours)"/>
    <field name="breakTimeHours" title="Break Time (hours)" hidden="true"/>
  </grid>

  <!-- Form View -->
  <form name="task-report-form" title="Task Reports" canEdit="true"
    model="com.axelor.apps.businessproject.db.TaskReport"
    onNew="action-task-report-default, action-task-report-attrs-filter-projects"
    onLoad="action-task-report-attrs-filter-projects" onSave="action-task-report-validate"
    width="large">
    <toolbar>
      <button name="viewTaskReportbtn" title="View Report" icon="fa-eye"
        onClick="save,action-task-report-method-preview"/>
    </toolbar>
    <panel colSpan="12" name="taskReportMainPanel">
      <panel colSpan="12" name="parentPanel" showFrame="true">
        <panel title="General Information" showFrame="false">
          <field name="project" title="Order" canView="false"
            domain-function="eval: ( (__user__.group.code == 'CUSTOM-PM' || __user__.group.code == 'CUSTOM-OM')
                    ? 'self.projectStatus.isCompleted = false'
                    : 'self.projectStatus.isCompleted = false AND (self.membersUserSet.id = :__user__ OR self.assignedTo.id = :__user__)' )"
            onChange="action-task-report-on-change-project" required="true"/>
          <field name="customer" hidden="true"/>
          <field name="customer" readonly="true" canView="false"/>
          <field name="location" canEdit="true" canView="false"/>
        </panel>

        <!-- Panel for Task Member Reports -->
        <panel title="Team Members Reports" canCollapse="true" collapseIf="false" colSpan="12">
          <field name="taskMemberReports" widget="list" colSpan="12" canNew="true"
            canEdit="true" form-view="task-member-report-form"
            onChange="action-update-total-work-hours"/>
          <panel>
            <field name="totalWorkHours"/>
          </panel>
        </panel>

        <panel colSpan="12" showFrame="false">
          <panel title="Extra charges" colSpan="6" showFrame="true">
            <field name="travelExpenses" colSpan="6" widget="checkbox"/>
            <field name="toolsUsage" colSpan="6" widget="checkbox"/>
          </panel>
          <panel title="Additional Services" colSpan="6" showFrame="true">
            <field name="dirtAllowance" colSpan="12" widget="checkbox"/>
          </panel>
          <panel title="Activity Details" colSpan="12" showTitle="false">
            <field name="material" colSpan="12" widget="textarea"/>
            <field name="comments" title="Comments" colSpan="12" widget="textarea"/>
          </panel>
        </panel>

        <panel title="Sign-Off" showFrame="false" colSpan="12">
          <panel colSpan="12">
            <field name="taskDate" colSpan="4"/>
            <field widget="checkbox" name="customerNotAvailable" colSpan="3" hidden="true"/>
            <field widget="checkbox" name="customerNotAvailable" colSpan="5"
              title="Customer Not Available" onChange="action-customer-available-attrs"/>
          </panel>
        </panel>
        <panel colSpan="12">
          <panel colSpan="12">
            <field name="employee" title="Employee Name"/>
            <field name="customerName" title="Customer Name" hideIf="customerNotAvailable"/>

            <field name="employeeSignature" title="Employee Signature" widget="drawing"
              colSpan="6"/>
            <field name="customerSignature" title="Customer Signature" widget="drawing"
              colSpan="6" hideIf="customerNotAvailable"/>
          </panel>
        </panel>
      </panel>
    </panel>
  </form>

  <!-- Define the form view for Task Member Report -->
  <form name="task-member-report-form" title="Team Member Report"
    onLoad="action-task-member-report-group-on-load" onNew="action-task-member-report-group-on-new"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <panel colSpan="12" canCollapse="true" collapseIf="false">
      <field name="task" title="Task" widget="Select"
        onChange="action-task-member-report-on-change-task" required="true"/>
      <field name="employee" title="Employee"/>
      <field name="startTime" onChange="action-task-report-on-change-time"/>
      <field name="breakTimeMinutes" title="Break Time (minutes)"
        onChange="action-task-member-report-sync-minutes-to-hours,action-task-report-on-change-time"/>
      <field name="endTime" onChange="action-task-report-on-change-time"/>
      <field name="task.projectTaskCategory" title="Task Category" readonly="true"/>
      <field name="workHours"/>
      <field name="breakTimeHours" hidden="true"/>
    </panel>
  </form>

  <action-attrs name="action-customer-available-attrs">
    <attribute for="customerName" name="hidden" expr="customerNotAvailable"/>
    <attribute for="customerSignature" name="hidden" expr="customerNotAvailable"/>
  </action-attrs>

  <action-attrs name="action-task-member-report-attrs-task-domain">
    <attribute for="task" name="domain"
      expr="eval: &quot;self.project.id = ${__parent__?.project?.id ?: 0}&quot;"/>
  </action-attrs>
  <action-attrs name="action-task-report-attrs-filter-projects">
    <attribute name="domain" for="project"
      expr="eval: __user__.group?.code == 'CUSTOM-PT' || __user__.group?.code == 'CUSTOM-TM' ?
    'self.projectStatus.isCompleted = false AND (self.membersUserSet[].id = ' + __user__.id + ' OR self.assignedTo.id = ' + __user__.id + ')' :
           'self.projectStatus.isCompleted = false'"/>
  </action-attrs>

  <action-method name="action-task-report-method-preview">
    <call class="com.axelor.apps.businessproject.web.TaskReportController"
      method="previewTaskReport"/>
  </action-method>

  <action-method name="action-task-report-validate">
    <call class="com.axelor.apps.businessproject.web.TaskReportController"
      method="validateTaskReport"/>
  </action-method>

  <!-- Action when project changes - autofill all related fields -->
  <action-record name="action-task-report-on-change-project"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <field name="customer" expr="eval: project?.clientPartner"/>
    <field name="location" expr="eval: project?.customerAddress"/>
    <field name="taskMemberReports" expr="eval: null"/>
  </action-record>

  <action-record name="action-task-member-report-on-change-task"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="employee" expr="eval: task?.assignedTo"/>
  </action-record>

  <action-record name="action-task-member-report-record-default-start-time"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="startTime" expr="eval: __datetime__"/>
  </action-record>

  <action-view name="action-task-report-dashlet" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <view type="grid" name="add-task-report-grid"/>
    <view type="form" name="task-report-preview-form"/>
    <view-param name="show-toolbar" value="true"/>
    <domain>
      self.project != null
      AND self.project.id = :projectId
      AND :__user__ MEMBER OF
      self.project.membersUserSet
    </domain>
    <context name="project" expr="eval:__parent__"/>
  </action-view>

  <action-view name="member-task-report" title="Member Task Reports"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <view type="form" name="task-member-report-form"/>
    <context name="employee" expr="eval: project?.membersUserSet"/>
    <context name="project" expr="eval: __parent__.project"/>
  </action-view>
  <action-view name="action-task-report-new" title="New Task Report"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <view type="form" name="task-report-form"/>
    <context name="project" expr="eval: _self"/>
    <context name="__new__" expr="true"/>
  </action-view>

  <action-record name="action-task-report-on-change-time"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="workHours"
      expr="eval:
      (startTime != null &amp;&amp; endTime != null)
      ? (
          (
            java.time.Duration.between(startTime, endTime).toMinutes() / 60.0
          ) - (breakTimeHours ?: 0)
        )
      : 0"/>
  </action-record>
  <action-record name="action-update-total-work-hours"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <field name="totalWorkHours"
      expr="eval: (taskMemberReports != null) ? taskMemberReports.stream().filter(r -> r.workHours != null).map(r -> r.workHours)
          .reduce(java.math.BigDecimal.ZERO, java.math.BigDecimal::add) : 0"/>
  </action-record>

  <action-record name="action-task-member-report-sync-minutes-to-hours"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="breakTimeHours"
      expr="eval: breakTimeMinutes != null ? (breakTimeMinutes / 60.0) : null"/>
  </action-record>

  <action-record name="action-task-member-report-sync-hours-to-minutes"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="breakTimeMinutes"
      expr="eval: breakTimeHours != null ? Math.round(breakTimeHours * 60) : null"/>
  </action-record>

  <action-group name="action-task-member-report-group-on-new">
    <action name="action-task-member-report-attrs-task-domain"/>
    <action name="action-task-member-report-record-default-start-time"/>
  </action-group>

  <action-group name="action-task-member-report-group-on-load">
    <action name="action-task-member-report-attrs-task-domain"/>
    <action name="action-task-member-report-sync-hours-to-minutes"/>
  </action-group>

</object-views>