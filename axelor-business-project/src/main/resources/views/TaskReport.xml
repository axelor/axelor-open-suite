<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views
                                  http://axelor.com/xml/ns/object-views/object-views_7.4.xsd">

  <!-- Grid View -->
  <grid name="task-report-grid" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <toolbar>
      <button name="btnTaskReportPrint" title="Print Task Reports"
        onClick="action-task-report-method-print"/>
      <button name="addTaskReportBtn" onClick="action-business-project-add-task-report"
        title="New Task Report" if="__config__.app.isApp('business-project')"
        if-module="axelor-business-project" showIf="id &amp;&amp; isBusinessProject"/>
    </toolbar>
    <field name="project" title="Order "/>
    <field name="customer.simpleFullName" title="Customer"/>
    <field name="taskDate" title="Date"/>
    <field name="location"/>
    <field name="totalWorkHours"/>
  </grid>
  <!-- Grid View for TaskMemberReport -->
  <grid name="task-member-report-grid" title="Team Members' Reports"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <field name="employee" title="Employee"/>
    <field name="task" title="Task"/>
    <field name="startTime" title="Start Time"/>
    <field name="endTime" title="End Time"/>
    <field name="totalWorkHours" title="Work Hours"/>
  </grid>

  <!-- Form View -->
  <form name="task-report-form" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport" onNew="action-task-report-default">

    <panel title="General Information">
      <field name="project" title="Order"
        domain="self.membersUserSet.id = :__user__ OR self.assignedTo.id = :__user__"
        onChange="action-task-report-on-change-project" required="true"/>
      <field name="customer" hidden="true"/>
      <field name="customer"/>
      <field name="location" canEdit="true"/>
    </panel>

    <!-- Panel for Task Member Reports -->
    <panel title="Team Members' Reports" canCollapse="true" collapseIf="true">
      <field name="taskMemberReports" widget="list" colSpan="12" readonly="false"
        form="task-member-report-form"/>
    </panel>

    <panel colSpan="12" canCollapse="true" collapseIf="true" title="Members">
      <field name="projectMembers" title="Team Members" widget="TagSelect" colSpan="12"
        canEdit="false"/>
    </panel>
    <panel colSpan="12" canCollapse="true" collapseIf="true" title="Tasks">
      <field name="tasks" title="Tasks" widget="TagSelect" colSpan="12" canEdit="false"
        domain="project.id = :project"/>
    </panel>

    <panel title="Work Timing">
      <field name="startTime" onChange="action-task-report-on-change-time"/>
      <field name="breakTimeHours" onChange="action-task-report-on-change-time"/>
      <field name="endTime" onChange="action-task-report-on-change-time"/>
      <field name="totalWorkHours"/>
    </panel>

    <panel title="Work Details" canCollapse="true" collapseIf="true">
      <field name="activities" colSpan="12" widget="TagSelect" canEdit="false"/>
    </panel>

    <panel colSpan="12">
      <panel title="Extra charges" colSpan="6" showFrame="true">
        <field name="travelExpenses" colSpan="6" widget="checkbox"/>
        <field name="toolsUsage" colSpan="6" widget="checkbox"/>
      </panel>
      <panel title="Additional Services" colSpan="6" showFrame="true">
        <field name="emergencyService" colSpan="6" widget="checkbox"/>
        <field name="dirtAllowance" colSpan="6" widget="checkbox"/>
      </panel>
      <panel title="Activity Details" colSpan="12" showTitle="false">
        <field name="material" colSpan="12" widget="textarea"/>
        <field name="otherServices" colSpan="12" widget="textarea"/>
        <field name="comments" title="Comments" colSpan="12" widget="textarea"/>
      </panel>
    </panel>

    <panel title="Sign-Off">
      <panel colSpan="12">
        <field name="taskDate" colSpan="4"/>
      </panel>
      <panel colSpan="12">
        <field name="employee" title="Employee Name"/>
        <field name="customerName" title="Customer Name" required="true"/>

        <field name="employeeSignature" title="Employee Signature" widget="drawing"
          colSpan="6"/>
        <field name="customerSignature" title="Customer Signature" widget="drawing"
          colSpan="6"/>
      </panel>
    </panel>
  </form>

  <!-- Define the form view for Task Member Report -->
  <form name="task-member-report-form" title="Team Member Report"
    model="com.axelor.apps.businessproject.db.TaskMemberReport" onLoad="member-task-report">
    <panel colSpan="12" canCollapse="true" collapseIf="false">
      <field name="employee" title="Employee"/>
      <field name="tasks" title="Tasks" widget="TagSelect" colSpan="12" canEdit="false"
        domain="project.id = :project"/>
      <field name="startTime" onChange="action-task-report-on-change-time"/>
      <field name="breakTimeHours" onChange="action-task-report-on-change-time"/>
      <field name="endTime" onChange="action-task-report-on-change-time"/>
      <field name="totalWorkHours" title="Work Hours" readonly="true"/>
      <field name="activities" colSpan="12" widget="TagSelect" canEdit="false"/>
    </panel>
  </form>


  <action-method name="action-task-report-method-print">
    <call class="com.axelor.apps.businessproject.web.TaskReportController"
      method="printTaskReport"/>
  </action-method>

  <action-view name="task-report-view" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <view type="grid" name="task-report-grid"/>
    <view type="form" name="task-report-form"/>
  </action-view>

  <!-- Action when project changes - auto-fill all related fields -->
  <action-record name="action-task-report-on-change-project"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <field name="customer" expr="eval: project?.clientPartner"/>
    <field name="location" expr="eval: project?.customerAddress"/>
    <field name="projectMembers" expr="eval: project?.membersUserSet"/>
    <field name="tasks" expr="eval: project?.projectTaskList"/>
  </action-record>

  <action-view name="action-task-report-dashlet" title="Task Reports"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <view type="grid" name="task-report-grid"/>
    <view type="form" name="task-report-form"/>
    <!-- <domain>self.project.id = :project</domain> -->
  </action-view>

  <action-view name="member-task-report" title="Member Task Reports"
    model="com.axelor.apps.businessproject.db.TaskMemberReport">
    <view type="form" name="task-member-report-form"/>
    <view-param name="popup" value="reload"/>
    <context name="project" expr="eval: _self"/>
    <context name="tasks" expr="eval: project?.projectTaskList"/>
    <context name="projectMembers" expr="eval: project?.membersUserSet"/>
  </action-view>

  <action-record name="action-task-report-on-change-time"
    model="com.axelor.apps.businessproject.db.TaskReport">
    <field name="totalWorkHours"
      expr="eval: (startTime != null &amp;&amp; endTime != null) ? ( (java.time.Duration.between(startTime.toLocalTime(), endTime.toLocalTime()).toMinutes() / 60.0) - (breakTimeHours ?: 0) ) : 0"/>
  </action-record>

</object-views>