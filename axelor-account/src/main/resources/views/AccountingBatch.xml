<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_7.4.xsd">

  <grid name="accounting-batch-grid" title="Accounting batches"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="actionSelect"/>
    <field name="code" x-bind="{{code|unaccent|uppercase}}"/>
    <field name="company" form-view="company-form" grid-view="company-grid"
      if="__config__.app.getApp('base')?.getEnableMultiCompany()"/>
    <field name="createdOn"/>
    <field name="createdBy" form-view="user-form" grid-view="user-grid"/>
  </grid>

  <form onNew="action-accounting-batch-group-on-new" name="accounting-batch-form"
    title="Accounting Batch" model="com.axelor.apps.account.db.AccountingBatch"
    onLoad="action-accounting-batch-group-on-load">
    <panel name="mainPanel">
      <field name="actionSelect"
        onChange="action-accounting-batch-group-action-select-on-change"/>
      <field name="code" x-bind="{{code|unaccent|uppercase}}"
        onChange="action-base-batch-condition-check-unique-code"/>
      <field name="company" canEdit="false" widget="SuggestBox" form-view="company-form"
        grid-view="company-grid" onChange="action-accounting-batch-group-company-on-change"/>
      <field name="fetchLimit"
        help="Fetch limit for this batch. 0 will not be taken into account. In this case, the value configured in app Base will be used."/>
      <field name="bankDetails"
        hideIf="actionSelect &amp;&amp; ([14,15,16,17,18,21,25,26,27].indexOf(actionSelect) &gt; -1 || (actionSelect == 11 &amp;&amp; reimbursementTypeSelect == 2) || (actionSelect == 12 &amp;&amp; directDebitDataTypeSelect == 2))"
        requiredIf="actionSelect &amp;&amp; actionSelect == 19 &amp;&amp; creditTransferTypeSelect == 2 &amp;&amp; paymentMode.typeSelect == 9 &amp;&amp; paymentMode.inOutSelect == 2"
        widget="SuggestBox" onSelect="action-accounting-batch-attrs-bank-details-domain"
        form-view="bank-details-form" grid-view="bank-details-grid"/>
      <field name="company.tradingNameList" colSpan="12" hidden="true"/>
      <field name="isDebtRecoveryByTradingName"
        readonlyIf="company.tradingNameList == null || company.tradingNameList.length == 0"
        onChange="action-attrs-accounting-batch-hide-trading-name-set" hidden="true"
        if="__config__.app.getApp('base')?.getEnableTradingNamesManagement()"
        showIf="actionSelect == 14"/>
      <field name="tradingNameSet" colSpan="12" grid-view="trading-name-grid"
        widget="TagSelect" form-view="trading-name-form" domain="self.company = :company"
        canNew="false" if="__config__.app.getApp('base')?.getEnableTradingNamesManagement()"
        hidden="true" canEdit="false"/>
      <field name="archived" title="Archived"/>
      <field name="paymentMode.typeSelect" hidden="true"/>
      <field name="paymentMode.inOutSelect" hidden="true"/>
    </panel>
    <panel-tabs name="mainPanelTab">
      <panel name="reimbursementPagePanel" title="Reimbursement configuration"
        hideIf="actionSelect != 11">
        <field name="reimbursementTypeSelect"/>
        <field name="reimbursementExportTypeSelect" hideIf="reimbursementTypeSelect != 1"/>
        <field name="currency" canEdit="false" readonly="true" grid-view="currency-grid"
          form-view="currency-form"/>
      </panel>
      <panel name="directDebitPagePanel" title="Direct debit configuration"
        hideIf="actionSelect != 12">
        <field name="directDebitDataTypeSelect"/>
        <field name="paymentMode" grid-view="payment-mode-grid" form-view="payment-mode-form"
          onSelect="action-attrs-accounting-batch-domain-payment-mode"/>
        <field name="dueDate"/>
        <field name="currency"/>
        <field name="includeOtherBankAccounts"
          if="__config__.app.getApp('base')?.getManageMultiBanks()"/>
      </panel>
      <panel name="billOfExchangePagePanel" title="Bill of exchange configuration"
        hideIf="actionSelect != 24">
        <field name="billOfExchangeStepBatchSelect" widget="NavSelect" colSpan="12"/>
        <field name="billOfExchangeDataTypeSelect" selection-in="[1]"
          readonlyIf="billOfExchangeStepBatchSelect != 1"
          requiredIf="actionSelect == 24 &amp;&amp; billOfExchangeStepBatchSelect == 1"/>
        <field name="billOfExhangeMailTemplate" showIf="billOfExchangeStepBatchSelect == 2"
          requiredIf="actionSelect == 24 &amp;&amp; billOfExchangeStepBatchSelect == 2"
          domain="self.metaModel.name = 'NoteBills'"/>
        <field name="billOfExchangeTypeSelect" requiredIf="actionSelect == 24"/>
        <field name="billOfExchangeJournal" requiredIf="actionSelect == 24"/>
        <field name="paymentMode" grid-view="payment-mode-grid" form-view="payment-mode-form"
          onSelect="action-attrs-accounting-batch-domain-payment-mode"/>
        <field name="dueDate"/>
        <field name="currency"/>
        <field name="includeOtherBankAccounts"
          if="__config__.app.getApp('base')?.getManageMultiBanks()"/>
      </panel>

      <panel name="creditTransferPagePanel" title="Credit Transfer configuration"
        hideIf="actionSelect != 19">
        <field name="creditTransferTypeSelect"/>
        <field name="customerReimbursementTypeSelect"
          showIf="$contains([3], creditTransferTypeSelect)"/>
        <field name="paymentMode" grid-view="payment-mode-grid" form-view="payment-mode-form"
          onSelect="action-attrs-accounting-batch-domain-payment-mode"/>
        <field name="period" showIf="$contains([1], creditTransferTypeSelect)"
          domain="self.year.company = :company AND self.year.typeSelect = 1" form-view="period-form"
          grid-view="period-grid" canEdit="false" canView="false"/>
        <field name="dueDate" showIf="$contains([2, 3], creditTransferTypeSelect)"/>
        <field name="currency" showIf="$contains([2, 3], creditTransferTypeSelect)"/>
        <field name="includeOtherBankAccounts"
          showIf="$contains([1, 2, 3], creditTransferTypeSelect)"
          if="__config__.app.getApp('base')?.getManageMultiBanks()"/>
        <field name="paymentMode.typeSelect"/>
        <field name="paymentMode.inOutSelect"/>
      </panel>

      <panel name="debtRecoveryPagePanel" title="Debt recovery configuration"
        hideIf="actionSelect != 14">
        <field name="debtRecoveryTypeSelect"/>
      </panel>

      <panel name="accountCustomerPagePanel" title="Account calculation configuration"
        hideIf="actionSelect != 17">
        <field name="updateCustAccountOk"/>
        <field name="updateDueCustAccountOk"/>
        <field name="updateDueDebtRecoveryCustAccountOk"/>
      </panel>
      <panel name="moveLineExportPagePanel" title="Move Lines Export Config"
        hideIf="actionSelect != 18">
        <field name="moveLineExportTypeSelect"/>
        <field name="startDate"/>
        <field name="endDate"/>
      </panel>
      <panel name="realizedFixedAssetLinesPagnel"
        title="Date range of realizing fixed asset lines" itemSpan="4" hideIf="actionSelect != 20">
        <field name="updateAllRealizedFixedAssetLines"/>
        <field name="startDate"
          requiredIf="!updateAllRealizedFixedAssetLines &amp;&amp; actionSelect == 20"
          showIf="!updateAllRealizedFixedAssetLines"/>
        <field name="endDate"
          requiredIf="!updateAllRealizedFixedAssetLines &amp;&amp; actionSelect == 20"
          showIf="!updateAllRealizedFixedAssetLines"/>
      </panel>
      <panel name="yearOpeningOrClosureAccountsPagePanel" title="Close/open the accounts"
        hideIf="actionSelect != 21">
        <!-- TODO FILTER ON STATUS -->
        <field name="closeYear" colSpan="3"
          onChange="action-accounting-batch-record-set-close-all-accounts,action-accounting-batch-method-set-closure-account-set"/>
        <field name="year.toDate" showIf="closeYear" hidden="true" colSpan="3"/>
        <field name="openYear" colSpan="3"
          onChange="action-accounting-batch-record-set-open-all-accounts,action-accounting-batch-method-set-opening-account-set"/>
        <field name="year.reportedBalanceDate" showIf="openYear" hidden="true" colSpan="3"/>
        <field name="year"
          domain="self.typeSelect = 1 AND self.company = :company AND (self.statusSelect = 1 OR :closeYear is false)"
          canEdit="false" requiredIf="actionSelect == 21"
          onChange="action-accounting-batch-close-open-method-check-daybook"
          showIf="closeYear || openYear"/>
        <field name="allocatePerPartner" colSpan="3" showIf="closeYear || openYear"/>
        <field name="generatedMoveStatusSelect" colSpan="3" selection-in="[2,3,5]"
          requiredIf="actionSelect == 21" showIf="closeYear || openYear" widget="single-select"/>
        <label name="daybookRemainingLabel" hidden="true" css="label-danger" colSpan="12"/>
        <field name="moveDescription" colSpan="12" showIf="closeYear || openYear"/>
        <field name="$closeAllAccounts" title="Close all accounts (Balance c/f preparation) ?"
          type="boolean" onChange="action-accounting-batch-method-set-closure-account-set"
          showIf="closeYear &amp;&amp; year"/>
        <field name="$openAllAccounts" title="Open all accounts (Balance c/f) ?"
          type="boolean" onChange="action-accounting-batch-method-set-opening-account-set"
          showIf="openYear &amp;&amp; year"/>
        <panel-related field="closureAccountSet" form-view="account-form"
          grid-view="account-grid" canNew="false" canEdit="false"
          domain="self.company = :company AND self.accountType.technicalTypeSelect IN ('equity', 'provision', 'debt', 'immobilisation', 'currentAsset', 'receivable', 'payable', 'tax', 'cash', 'charge', 'income', 'asset')"
          showIf="closeYear &amp;&amp; !$closeAllAccounts"/>
        <panel-related field="openingAccountSet" form-view="account-form"
          grid-view="account-grid" canNew="false" canEdit="false"
          domain="self.company = :company AND self.accountType.technicalTypeSelect IN ('equity', 'provision', 'debt', 'immobilisation', 'currentAsset', 'receivable', 'payable', 'tax', 'cash', 'asset')"
          showIf="openYear &amp;&amp; !$openAllAccounts"/>
        <field name="generateResultMove" showIf="openYear"/>
        <field name="resultMoveDescription" showIf="generateResultMove"/>
        <field name="generateGeneralLedger" showIf="openYear"/>
        <field name="includeSpecialAccounts"
          showIf="openYear &amp;&amp; generateResultMove &amp;&amp; generateGeneralLedger"/>
        <field name="isDeleteSimulatedMove" readonlyIf="isDeleteSimulatedMove"
          showIf="company.accountConfig.isActivateSimulatedMove"/>
        <field name="company.accountConfig.isActivateSimulatedMove" hidden="true"/>
        <!-- <field name="journalSet" colSpan="12" form-view="journal-form" grid-view="journal-grid"
          widget="TagSelect" canNew="false" domain="self.company = :company"/> -->
      </panel>
      <panel name="moveConsistencyControl" title="Move Consistency Control"
        hideIf="actionSelect != 25">
        <panel-related field="yearSet" widget="TagSelect" canSelect="true"
          domain="self.typeSelect = 1 AND self.company = :company AND (self.statusSelect = 1 OR :closeYear is false)"
          canNew="false" canEdit="false" grid-view="year-account-grid" form-view="year-account-form"
          colSpan="12"/>
      </panel>
      <panel name="accountingCutOffConfigPanel" title="Accounting cut-off configuration"
        showIf="actionSelect == 26" colSpan="12">
        <field name="accountingCutOffTypeSelect"
          onChange="action-group-accounting-batch-onchange-accounting-type"/>
        <panel colSpan="3" itemSpan="12">
          <field name="moveDate" requiredIf="actionSelect == 26"
            validIf="actionSelect != 26 || $moment(moveDate).date() == $moment(moveDate).endOf('month').date()"
            help="Please, enter only dates with the last day of month"
            onChange="action-accounting-batch-group-move-date-onchange"/>
          <label name="adviseUser"
            title="This batch has already been running for this move date" hidden="true"
            css="label-danger"/>
        </panel>
        <field name="moveDescription" requiredIf="actionSelect == 26" colSpan="3"/>

        <panel name="expensesIncomesPanel" colSpan="12" itemSpan="3"
          showIf="actionSelect == 26">
          <field name="automaticReverse"/>
          <field name="automaticReconcile"
            showIf="automaticReverse &amp;&amp; generatedMoveStatusSelect != 5"/>
          <panel name="reversePanel" colSpan="6"
            showIf="actionSelect == 26 &amp;&amp; automaticReverse">
            <field name="reverseMoveDate"
              requiredIf="actionSelect == 26 &amp;&amp; automaticReverse"/>
            <field name="reverseMoveDescription"
              requiredIf="actionSelect == 26 &amp;&amp; automaticReverse"/>
          </panel>
          <field name="miscOpeJournal" colSpan="6"
            onChange="action-record-accounting-batch-journal-onchange,action-method-accounting-batch-generated-move-status-domain"
            requiredIf="actionSelect == 26"
            domain="self.company = :company AND self.statusSelect = 1"/>
          <field name="journalSet" colSpan="6" form-view="journal-form"
            grid-view="journal-grid" hideIf="accountingCutOffTypeSelect &lt;= 2"
            onSelect="action-attrs-accounting-batch-set-journal-domain" canNew="false"
            canEdit="false" widget="TagSelect"/>
          <field name="generatedMoveStatusSelect" colSpan="6" selection-in="[2,3,5]"
            widget="single-select"/>
          <spacer colSpan="6"/>
          <field name="recoveredTax" showIf="accountingCutOffTypeSelect &lt;= 2"/>
          <field name="ati"
            showIf="!recoveredTax &amp;&amp; accountingCutOffTypeSelect &lt;= 2"/>
          <field name="includeNotStockManagedProduct"
            showIf="accountingCutOffTypeSelect &lt;= 2"/>
        </panel>
        <field name="prefixOrigin"/>
      </panel>
      <panel name="autoMoveLetteringConfigPanel" title="Auto move lettering configuration"
        hideIf="actionSelect != 27" colSpan="12">
        <field name="startDate" requiredIf="actionSelect == 27"/>
        <field name="endDate" requiredIf="actionSelect == 27"/>
        <field name="fromAccount" requiredIf="actionSelect == 27 &amp;&amp; toAccount == null"
          domain="self.statusSelect = 1 AND self.reconcileOk IS true AND self.company = :company"/>
        <field name="toAccount" requiredIf="actionSelect == 27 &amp;&amp; fromAccount == null"
          domain="self.statusSelect = 1 AND self.reconcileOk IS true AND self.company = :company"/>
        <field name="partnerSet" form-view="partner-form" grid-view="partner-grid"
          widget="TagSelect"
          onSelect="action-accounting-batch-method-auto-lettering-set-partner-domain" canNew="false"
          canEdit="false" colSpan="12"/>
        <field name="orderBySelect" widget="MultiSelect"/>
        <field name="reconcileMethodSelect" widget="RadioSelect"
          onChange="action-accounting-batch-record-auto-lettering-set-partial-false"/>
        <field name="isPartialReconcile"
          readonlyIf="reconcileMethodSelect != 1 &amp;&amp; reconcileMethodSelect != 4"
          widget="boolean-switch"/>
        <field name="isProposal" widget="boolean-switch"/>
        <field name="$isShowMoveLinesInProposalBtnDisplayed" type="boolean" hidden="true"/>
      </panel>
      <panel name="informationPanel" title="Information">
        <field name="createdOn" title="Created on"/>
        <field name="createdBy" title="Created by" form-view="user-form" grid-view="user-grid"/>
        <field name="description" showTitle="false"/>
        <panel-dashlet name="batchListPanel" colSpan="12"
          action="action-batch-method-show-batches" canSearch="true"/>
      </panel>

    </panel-tabs>
    <panel name="actionsPanel" sidebar="true" title="Actions">
      <button name="reimbursementBatchBtn" title="Reimbursement Batch"
        showIf="actionSelect == 11"
        onClick="save,action-accounting-batch-method-action-reimbursement" colSpan="12"/>
      <button name="directDebitBatchBtn" title="Direct Debit Batch"
        showIf="actionSelect == 12"
        onClick="save,action-accounting-batch-method-action-direct-debit" colSpan="12"/>
      <button name="debtRecoveryBatchBtn" title="Debt recovery Batch"
        showIf="actionSelect == 14"
        onClick="save,action-accounting-batch-method-action-debt-recovery" colSpan="12"/>
      <button name="doubtfulCustomerBatchBtn" title="Doubtful Customer Batch"
        showIf="actionSelect == 16"
        onClick="save,action-accounting-batch-group-action-doubtful-customer" colSpan="12"/>
      <button name="accountCustomerBatchBtn" title="Start" showIf="actionSelect == 17"
        onClick="save,action-accounting-batch-method-action-account-customer" colSpan="12"/>
      <button name="moveLineExportBatchBtn" title="Start" showIf="actionSelect == 18"
        onClick="save,action-accounting-batch-method-action-move-line-export" colSpan="12"/>
      <button name="creditTransferBatchBtn" title="Credit Transfer Batch"
        showIf="actionSelect == 19"
        onClick="save,action-accounting-batch-method-action-credit-transfer" colSpan="12"/>
      <button name="realizeFixedAssetLinesBatchBtn" title="Realize Fixed asset lines Batch"
        showIf="actionSelect == 20"
        onClick="save,action-accounting-batch-group-realize-fixed-asset-lines" colSpan="12"/>
      <button name="closeAnnualAccountsBatchBtn" title="Start" showIf="actionSelect == 21"
        onClick="save,action-accounting-batch-group-close-annual-accounts" colSpan="12"/>
      <button name="blockCustomerWithLatePayments" title="Block customers with late payments"
        showIf="actionSelect == 23"
        readonlyIf="!company?.accountConfig?.hasLatePaymentAccountBlocking"
        onClick="save,action-accounting-batch-method-block-customers-with-late-payments"
        colSpan="12"/>
      <label
        title="Blocking customer with late payment issues is not activated for this company"
        css="label-danger"
        showIf="actionSelect == 23 &amp;&amp; !company.accountConfig.hasLatePaymentAccountBlocking"/>
      <field name="company.accountConfig.hasLatePaymentAccountBlocking" hidden="true"/>
      <button name="billOfExchangeBatchBtn" title="Bill of exchange batch"
        showIf="actionSelect == 24" onClick="save,action-accounting-batch-method-bill-of-exchange"
        colSpan="12"/>
      <button name="billOfExchangeInvoicesBtn" title="Display invoices to be processed"
        onClick="save,action-method-accounting-batch-invoice-to-be-processed"
        showIf="actionSelect == 24 &amp;&amp; billOfExchangeStepBatchSelect == 1" colSpan="12"/>
      <button name="movesConsistencyControl" title="Control moves consistency"
        showIf="actionSelect == 25"
        onClick="save,action-accounting-batch-method-moves-consistency-control"/>
      <button name="accountingCutOffBatchBtn" title="Run accounting cut-off"
        showIf="actionSelect == 26" onClick="action-accounting-batch-group-accounting-cut-off"/>
      <field name="previewRecordsToProcess" colSpan="12" widget="boolean-switch"
        showIf="[16,26].includes(actionSelect)"/>
      <button name="autoMoveLetteringBatchBtn" title="Run auto move lettering"
        showIf="actionSelect == 27" onClick="action-accounting-batch-group-auto-move-lettering"/>
      <button name="showMoveLinesInProposalBtn"
        title="Show move lines linked to reconcile group proposals"
        showIf="$isShowMoveLinesInProposalBtnDisplayed"
        onClick="action-accounting-batch-method-show-move-lines-in-proposal"/>
      <label name="proposalNotEnabledLabel" showIf="actionSelect == 27 &amp;&amp; !isProposal"
        title="Warning, the option of lettering proposal is not activated, the realized reconcile groups will be definitively validated without the possibility of checking them beforehand."
        css="label-danger"/>

    </panel>
  </form>
  <action-method name="action-method-accounting-batch-invoice-to-be-processed">
    <call class="com.axelor.apps.bankpayment.web.AccountingBatchController"
      method="searchInvoicesToBeProcessed"/>
  </action-method>

  <!-- ACTION GROUP -->
  <action-group name="action-accounting-batch-group-close-annual-accounts">
    <action name="action-accounting-batch-validate-batchlist-not-empty"/>
    <action name="action-accounting-batch-method-validate-daybook-moves"/>
    <action name="action-accounting-batch-method-action-close-annual-accounts"/>
    <action name="action-accounting-batch-method-print-report"/>
  </action-group>

  <action-group name="action-accounting-batch-group-realize-fixed-asset-lines">
    <action name="action-accounting-batch-validate-realized-fixed-date"/>
    <action name="action-accounting-batch-method-action-fixed-asset-lines-realize"/>
  </action-group>

  <action-group name="action-accounting-batch-group-on-new">
    <action name="action-accounting-batch-record-on-new"/>
    <action name="action-attrs-accounting-batch-hide-trading-name-set"/>
  </action-group>

  <action-group name="action-accounting-batch-group-on-load">
    <action name="action-attrs-accounting-batch-hide-trading-name-set"/>
    <action name="action-accounting-batch-attrs-show-label"/>
    <action name="action-method-accounting-batch-generated-move-status-domain"
      if="[21,26].contains(actionSelect)"/>
    <action name="action-accounting-batch-close-open-method-check-daybook"
      if="actionSelect == 21"/>
    <action name="action-accounting-batch-method-set-close-all-accounts"
      if="actionSelect == 21"/>
    <action name="action-accounting-batch-method-set-open-all-accounts"
      if="actionSelect == 21"/>
  </action-group>

  <action-group name="action-accounting-batch-group-accounting-cut-off">
    <action name="save"/>
    <action name="action-accounting-batch-validate-cut-off-move-status"/>
    <action name="action-accounting-batch-method-compute-move-line-cut-off-fields"
      if="previewRecordsToProcess &amp;&amp; [3,4].contains(accountingCutOffTypeSelect)"/>
    <action name="action-accounting-batch-view-preview-move-lines-to-process"
      if="previewRecordsToProcess"/>
    <action name="action-accounting-batch-validate-twice-in-a-month"
      if="!previewRecordsToProcess"/>
    <action name="action-accounting-batch-method-accounting-cut-off"
      if="!previewRecordsToProcess"/>
  </action-group>

  <action-group name="action-group-accounting-batch-onchange-accounting-type">
    <action name="action-accounting-batch-attrs-show-label"/>
    <action name="action-record-accounting-batch-set-expenses-incomes"/>
    <action name="action-method-accounting-batch-generated-move-status-domain"/>
  </action-group>

  <action-group name="action-accounting-batch-group-move-date-onchange">
    <action name="action-accounting-batch-attrs-show-label"/>
    <action name="action-record-accounting-batch-movedate-onchange"/>
  </action-group>

  <action-group name="action-accounting-batch-group-company-on-change">
    <action name="action-accounting-batch-attrs-set-empty-year-and-accountset-value"/>
    <action name="action-accounting-batch-attrs-set-company-currency"
      if="[11,12,19].contains(actionSelect)"/>
  </action-group>

  <action-group name="action-accounting-batch-group-auto-move-lettering">
    <action name="action-accounting-batch-validate-reconcile-dates"/>
    <action name="save"/>
    <action name="action-accounting-batch-method-auto-move-lettering"/>
  </action-group>

  <action-group name="action-accounting-batch-group-action-doubtful-customer">
    <action name="action-accounting-batch-view-action-doubtful-customer"
      if="previewRecordsToProcess"/>
    <action name="action-accounting-batch-method-action-doubtful-customer"
      if="!previewRecordsToProcess"/>
  </action-group>

  <action-group name="action-accounting-batch-group-action-select-on-change">
    <action name="action-accounting-batch-record-default-currency"/>
    <action name="action-attrs-accounting-batch-hide-trading-name-set"/>
    <action name="action-accounting-batch-record-set-is-delete-simulated-move"/>
    <action name="action-method-accounting-batch-generated-move-status-domain"
      if="[21,26].contains(actionSelect)"/>
  </action-group>

  <!-- ACTION RECORD -->
  <action-record name="action-accounting-batch-record-on-new"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="createdOn"
      expr="eval: __config__.app.getTodayDateTime(__user__.activeCompany)"/>
    <field name="createdOn"
      expr="eval: __config__.app.getTodayDateTime(__repo__(Company).all().fetchOne())"
      if="__user__.activeCompany == null &amp;&amp; __repo__(Company).all().count() == 1"/>
    <field name="createdBy" expr="eval:__user__"/>
    <field name="company" expr="eval:__user__.activeCompany"
      if="__user__.activeCompany != null"/>
    <field name="company" expr="eval:__repo__(Company).all().fetchOne()"
      if="__user__.activeCompany == null &amp;&amp; __repo__(Company).all().count() == 1"/>
    <field name="billOfExchangeStepBatchSelect" expr="eval: 1"/>
    <field name="actionSelect" expr="eval: _actionSelect" if="_actionSelect"/>
  </action-record>

  <action-record name="action-accounting-batch-record-set-is-delete-simulated-move"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="isDeleteSimulatedMove"
      expr="eval: company?.accountConfig?.isActivateSimulatedMove"/>
  </action-record>

  <action-record name="action-accounting-batch-record-default-currency"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="currency" expr="eval: company?.currency"
      if="[11, 12, 15, 19].indexOf(actionSelect) >= 0"/>
  </action-record>

  <action-record name="action-record-accounting-batch-set-expenses-incomes"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="automaticReconcile" expr="true"/>
    <field name="automaticReverse" expr="true"/>
    <field name="previewRecordsToProcess" expr="true"/>
    <field name="moveDate"
      expr="eval: __date__.with(java.time.temporal.TemporalAdjusters.lastDayOfMonth())"/>
    <field name="moveDate"
      expr="eval: __config__.date.with(java.time.temporal.TemporalAdjusters.lastDayOfMonth())"
      if="__user__.activeCompany != null"/>
    <field name="reverseMoveDate"
      expr="eval: __date__.with(java.time.temporal.TemporalAdjusters.lastDayOfMonth()).plusDays(1)"/>
    <field name="reverseMoveDate"
      expr="eval: __config__.date.with(java.time.temporal.TemporalAdjusters.lastDayOfMonth()).plusDays(1)"
      if="__user__.activeCompany != null"/>
    <field name="generatedMoveStatusSelect" expr="eval: __repo__(Move).STATUS_ACCOUNTED"/>
    <field name="journalSet" expr="eval: null"/>
  </action-record>

  <action-record name="action-record-accounting-batch-movedate-onchange"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="reverseMoveDate" expr="eval: moveDate.plusDays(1)"
      if="accountingCutOffTypeSelect != null &amp;&amp;moveDate != null"/>
  </action-record>

  <action-record name="action-record-accounting-batch-journal-onchange"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="generatedMoveStatusSelect" expr="eval: null"/>
    <field name="generatedMoveStatusSelect" expr="eval: __repo__(Move).STATUS_SIMULATED"
      if="miscOpeJournal?.authorizeSimulatedMove"/>
    <field name="generatedMoveStatusSelect" expr="eval: __repo__(Move).STATUS_DAYBOOK"
      if="!miscOpeJournal?.authorizeSimulatedMove &amp;&amp; miscOpeJournal?.allowAccountingDaybook"/>
  </action-record>

  <action-record
    name="action-accounting-batch-record-auto-lettering-set-partial-false"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="isPartialReconcile" expr="eval: false"/>
  </action-record>

  <!-- ACTION METHOD -->
  <action-method
    name="action-accounting-batch-method-block-customers-with-late-payments">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="blockCustomersWithLatePayments"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-reimbursement">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionReimbursement"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-direct-debit">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionDirectDebit"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-debt-recovery">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionDebtRecovery"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-doubtful-customer">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionDoubtfulCustomer"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-account-customer">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionAccountingCustomer"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-move-line-export">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionMoveLineExport"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-credit-transfer">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionCreditTransfer"/>
  </action-method>

  <action-method
    name="action-accounting-batch-method-action-fixed-asset-lines-realize">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionRealizeFixedAssetLines"/>
  </action-method>

  <action-method name="action-accounting-batch-method-action-close-annual-accounts">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionCloseAnnualAccounts"/>
  </action-method>

  <action-method name="action-accounting-batch-method-bill-of-exchange">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionBillOfExchange"/>
  </action-method>

  <action-method name="action-accounting-batch-method-print-report">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="printAccountingReport"/>
  </action-method>

  <action-method name="action-accounting-batch-method-moves-consistency-control">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="controlMoveConsistency"/>
  </action-method>

  <action-method
    name="action-accounting-batch-method-compute-move-line-cut-off-fields">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="computeMoveLineCutOffFields"/>
  </action-method>

  <action-method name="action-accounting-batch-method-accounting-cut-off">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionAccountingCutOff"/>
  </action-method>

  <action-method name="action-accounting-batch-method-auto-move-lettering">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="actionAutoMoveLettering"/>
  </action-method>

  <action-method
    name="action-accounting-batch-method-auto-lettering-set-partner-domain">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="setLetteringPartnersDomain"/>
  </action-method>

  <action-method name="action-accounting-batch-method-show-move-lines-in-proposal">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="showMoveLinesInProposal"/>
  </action-method>

  <action-method name="action-method-accounting-batch-generated-move-status-domain">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="setGeneratedStatusDomain"/>
  </action-method>

  <action-method name="action-accounting-batch-close-open-method-check-daybook">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="checkDaybookMovesOnFiscalYearLabel"/>
  </action-method>

  <action-method name="action-accounting-batch-method-validate-daybook-moves">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="checkDaybookMovesOnFiscalYearWarning"/>
  </action-method>

  <!-- ACTION VALIDATE -->
  <action-validate name="action-accounting-batch-validate-batchlist-not-empty">
    <alert
      message="The batch to close the annual accounts has already ran. Are you sure you want to continue?"
      if="eval: batchList &amp;&amp; !batchList?.empty"/>
  </action-validate>

  <action-validate name="action-accounting-batch-validate-realized-fixed-date">
    <error message="Please enter valid start date and end date"
      if="eval: !updateAllRealizedFixedAssetLines &amp;&amp; startDate &gt; endDate"/>
  </action-validate>

  <action-validate name="action-accounting-batch-validate-cut-off-move-status">
    <error
      message="The selected cut off move status is incompatible with this misc. operation journal"
      if="(!miscOpeJournal?.authorizeSimulatedMove &amp;&amp; generatedMoveStatusSelect == 5) || (!miscOpeJournal?.allowAccountingDaybook &amp;&amp; generatedMoveStatusSelect == 2)"/>
  </action-validate>

  <action-validate name="action-accounting-batch-validate-reconcile-dates">
    <error if="startDate &gt; endDate" message="End date cannot be inferior to start date"/>
  </action-validate>


  <!-- ACTION ATTRS -->

  <action-attrs name="action-accounting-batch-attrs-bank-details-domain">
    <attribute name="domain"
      expr="eval: &quot;self.id IN (${company?.bankDetailsList?.collect{it.id}.join(',')},${company?.defaultBankDetails?.id}) AND self.active = true&quot;"
      for="bankDetails" if="!company.bankDetailsList.isEmpty()"/>
    <attribute name="domain"
      expr="eval: &quot;self.id = ${company?.defaultBankDetails?.id} AND self.active = true&quot;"
      for="bankDetails" if="company.bankDetailsList.isEmpty()"/>
  </action-attrs>

  <action-attrs
    name="action-accounting-batch-attrs-set-empty-year-and-accountset-value">
    <attribute name="value" expr="eval: null"
      for="year,closureAccountSet,openingAccountSet"/>
  </action-attrs>

  <action-attrs name="action-attrs-accounting-batch-domain-payment-mode">
    <attribute name="domain" for="paymentMode" expr="eval: 'self.typeSelect = 10'"
      if="actionSelect == 24"/>
    <attribute name="domain" for="paymentMode" expr="eval: 'self.typeSelect = 9'"
      if="actionSelect == 19"/>
    <attribute name="domain" for="paymentMode"
      expr="eval: 'self.typeSelect = 2 AND self.inOutSelect = 1'" if="actionSelect == 12"/>
  </action-attrs>

  <action-attrs name="action-attrs-accounting-batch-hide-trading-name-set">
    <attribute name="hidden" for="tradingNameSet"
      expr="eval: actionSelect != 27 &amp;&amp; !(actionSelect == 14 &amp;&amp; isDebtRecoveryByTradingName)"/>
  </action-attrs>

  <action-attrs name="action-accounting-batch-attrs-show-label">
    <attribute name="hidden"
      expr="eval: !(moveDate &amp;&amp; batchList &amp;&amp; batchList?.find{it.moveDate.equals(moveDate) &amp;&amp; it.accountingCutOffTypeSelect == accountingCutOffTypeSelect} != null)"
      for="adviseUser"/>
  </action-attrs>

  <action-attrs name="action-attrs-accounting-batch-set-journal-domain">
    <attribute name="domain" expr="eval: &quot;self.company = :company&quot;"
      for="journalSet"/>
    <attribute name="domain"
      expr="eval: &quot;self.journalType.technicalTypeSelect = 1 AND self.company = :company AND self.statusSelect = 1&quot;"
      for="journalSet" if="accountingCutOffTypeSelect == 3"/>
    <attribute name="domain"
      expr="eval: &quot;self.journalType.technicalTypeSelect = 2 AND self.company = :company AND self.statusSelect = 1&quot;"
      for="journalSet" if="accountingCutOffTypeSelect == 4"/>
  </action-attrs>

  <action-view name="action-accounting-batch-view-preview-move-lines-to-process"
    title="Move lines concerned by cut off" model="com.axelor.apps.account.db.MoveLine">
    <view type="grid" name="move-line-cut-off-grid"/>
    <view type="form" name="move-line-form"/>
    <domain>
      self.account.manageCutOffPeriod IS TRUE
      AND self.cutOffStartDate IS NOT NULL
      AND
      self.cutOffEndDate IS NOT NULL
      AND ((0 NOT IN (:_journalSet) AND self.move.journal.id IN
      (:_journalSet))
      OR (0 IN (:_journalSet) AND
      self.move.journal.journalType.technicalTypeSelect =
      :_journalType))
      AND DATE(:_moveDate) >=
      self.move.date
      AND self.move.statusSelect IN (2, 3, 5)
      AND self.cutOffEndDate > DATE(:_moveDate)
      AND self.move.company.id = :_company
    </domain>
    <context name="_journalSet"
      expr="eval: journalSet.isEmpty() ? [0] : journalSet.collect{it.id}"/>
    <context name="_journalType" expr="eval: accountingCutOffTypeSelect == 3 ? 1 : 2"/>
    <context name="_moveDate" expr="eval: moveDate"/>
    <context name="_company" expr="eval: company.id"/>
    <context name="_cutOffPreview" expr="eval: true"/>
    <context name="_batchId" expr="eval: id"/>
    <context name="_actionSelect" expr="eval: actionSelect"/>
  </action-view>

  <action-view name="action-accounting-batch-view-action-doubtful-customer"
    title="Move lines concerned by doubtful customer" model="com.axelor.apps.account.db.MoveLine">
    <view type="grid" name="move-line-doubtful-customer-grid"/>
    <view type="form" name="move-line-form"/>
    <domain>self.id IN :_moveLineIds</domain>
    <context name="_moveLineIds"
      expr="call: com.axelor.apps.account.service.debtrecovery.DoubtfulCustomerService:getDoubtfulCustomerPreviewList(company,company.accountConfig.doubtfulCustomerAccount)"/>
    <context name="_batchId" expr="eval: id"/>
    <context name="_actionSelect" expr="eval: actionSelect"/>
  </action-view>

  <action-validate name="action-accounting-batch-validate-twice-in-a-month">
    <alert
      message="The batch has already been running for this move date. Are you sure to continue ?"
      if="eval: moveDate &amp;&amp; batchList &amp;&amp; batchList?.find{it.moveDate.equals(moveDate) &amp;&amp; it.accountingCutOffTypeSelect == accountingCutOffTypeSelect} != null"/>
  </action-validate>

  <action-attrs name="action-accounting-batch-attrs-set-company-currency">
    <attribute for="currency" name="value" expr="eval: company?.currency"/>
  </action-attrs>

  <action-record name="action-accounting-batch-record-set-close-all-accounts"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="$closeAllAccounts" expr="eval: closeYear"/>
  </action-record>

  <action-record name="action-accounting-batch-record-set-open-all-accounts"
    model="com.axelor.apps.account.db.AccountingBatch">
    <field name="$openAllAccounts" expr="eval: openYear"/>
  </action-record>

  <action-method name="action-accounting-batch-method-set-close-all-accounts">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="setCloseAllAccounts"/>
  </action-method>

  <action-method name="action-accounting-batch-method-set-open-all-accounts">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="setOpenAllAccounts"/>
  </action-method>

  <action-method name="action-accounting-batch-method-set-closure-account-set">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="setClosureAccountSet"/>
  </action-method>

  <action-method name="action-accounting-batch-method-set-opening-account-set">
    <call class="com.axelor.apps.account.web.AccountingBatchController"
      method="setOpeningAccountSet"/>
  </action-method>

  <search-filters name="accounting-batch-filters"
    model="com.axelor.apps.account.db.AccountingBatch" title="Accounting batch filters">
    <field name="company" hidden="true"
      if="!__config__.app.getApp('base')?.getEnableMultiCompany()"/>
    <field name="includeOtherBankAccounts" hidden="true"
      if="!__config__.app.getApp('base')?.getManageMultiBanks()"/>
  </search-filters>

</object-views>
