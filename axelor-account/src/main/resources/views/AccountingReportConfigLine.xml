<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.4.xsd">

  <grid title="Config lines" name="accounting-report-config-line-grid"
    model="com.axelor.apps.account.db.AccountingReportConfigLine" canMove="true" orderBy="sequence">
    <field name="code"/>
    <field name="label"/>
    <field name="typeSelect"/>
    <field name="ruleTypeSelect"/>
    <field name="hidden"/>
  </grid>

  <grid title="Config lines" name="accounting-report-config-line-account-grid"
    model="com.axelor.apps.account.db.AccountingReportConfigLine" orderBy="sequence">
    <field name="reportType"/>
    <field name="code"/>
    <field name="label"/>
    <field name="typeSelect"/>
    <field name="ruleTypeSelect"/>
    <field name="hidden"/>
    <button name="editConfigLineBtn" title="Edit config line" icon="fa-external-link"
      onClick="action-move-line-view-open-report-config-line"/>
  </grid>

  <form title="Column rule" name="accounting-report-config-line-column-rule-form"
    model="com.axelor.apps.account.db.AccountingReportConfigLine"
    onNew="action-accounting-report-config-line-record-column-rule">
    <panel-include view="accounting-report-config-line-form"/>
  </form>

  <form title="Line rule" name="accounting-report-config-line-line-rule-form"
    model="com.axelor.apps.account.db.AccountingReportConfigLine"
    onNew="action-accounting-report-config-line-group-line-onnew"
    onLoad="action-accounting-report-config-line-group-line-onnew">
    <panel-include view="accounting-report-config-line-form"/>
  </form>

  <form title="Config line" name="accounting-report-config-line-form"
    model="com.axelor.apps.account.db.AccountingReportConfigLine">
    <panel name="accountingReportConfigLineMainPanel">
      <panel name="reportTypePanel" stacked="true" colSpan="12" itemSpan="12"
        readonlyIf="$popup()">
        <field name="reportType" showIf="reportType != null"
          form-view="accounting-report-type-form" grid-view="accounting-report-type-grid"/>
        <field name="reportTypeColumn" showIf="reportTypeColumn != null"
          form-view="accounting-report-type-form" grid-view="accounting-report-type-grid"/>
        <field name="$legacy" hidden="true" type="boolean"/>
      </panel>
      <panel name="typePanel" stacked="true" itemSpan="12">
        <field name="typeSelect" showIf="reportTypeColumn == null" validIf="typeSelect > 0"
          selection-in="[1,2,3]"
          onChange="action-accounting-report-config-line-record-type-select-onchange"/>
        <field name="typeSelect" showIf="reportTypeColumn != null" validIf="typeSelect > 0"
          onChange="action-accounting-report-config-line-record-type-select-onchange"/>
      </panel>
      <panel name="ruleTypePanel" stacked="true" itemSpan="12" hideIf="typeSelect == 5">
        <field name="ruleTypeSelect" showIf="reportTypeColumn == null"
          requiredIf="typeSelect != 4" validIf="[4,5].includes(typeSelect) || ruleTypeSelect > 0"
          readonlyIf="typeSelect == 3" selection-in="[1,2,3]"
          onChange="action-accounting-report-config-lone-record-rule-type-select-onchange"/>
        <field name="ruleTypeSelect"
          showIf="reportTypeColumn != null &amp;&amp; typeSelect != 4"
          requiredIf="![4,5].includes(typeSelect)" validIf="typeSelect >= 4 || ruleTypeSelect > 0"
          readonlyIf="typeSelect == 3"
          onChange="action-accounting-report-config-lone-record-rule-type-select-onchange"/>
        <field name="ruleTypeSelect"
          showIf="reportTypeColumn != null &amp;&amp; typeSelect == 4" requiredIf="typeSelect == 4"
          validIf="typeSelect != 4 || ruleTypeSelect > 0" selection-in="[2,3]"/>
      </panel>
      <field name="label" showIf="[1,2,4].includes(typeSelect)"
        requiredIf="[1,2,4].includes(typeSelect)"/>
      <field name="code" showIf="[1,2,4].includes(typeSelect) &amp;&amp; ruleTypeSelect != 1"
        requiredIf="[1,2,4].includes(typeSelect) &amp;&amp; ruleTypeSelect != 1"/>
      <panel name="resultPanel" stacked="true" showIf="ruleTypeSelect == 2">
        <field name="resultSelect" showIf="reportTypeColumn != null"
          requiredIf="ruleTypeSelect == 2" selection-in="[1,2,4,5]"/>
        <field name="resultSelect" showIf="reportType != null"
          requiredIf="ruleTypeSelect == 2" selection-in="[1,2,3,5]"/>
      </panel>
      <panel name="percentagePanel" stacked="true"
        showIf="[2,3,4].includes(ruleTypeSelect) &amp;&amp; !$legacy">
        <field name="percentageTotalLine" showIf="reportType != null"/>
        <field name="percentageBaseColumn"
          showIf="reportTypeColumn != null &amp;&amp; ruleTypeSelect == 4"/>
      </panel>
      <panel name="configPanel" colSpan="12"
        showIf="typeSelect != 4 &amp;&amp; [2,3,4].includes(ruleTypeSelect)">
        <field name="hidden"/>
        <field name="notComputedIfIntersect" hideIf="$legacy"/>
        <panel name="columnConfigPanel" colSpan="12"
          showIf="reportTypeColumn != null &amp;&amp; ruleTypeSelect == 2 &amp;&amp; !$legacy">
          <field name="computePreviousYear" hideIf="computeOtherPeriod"/>
          <field name="computeOtherPeriod" hideIf="computePreviousYear"/>
        </panel>
        <field name="priority"
          showIf="typeSelect != 4 &amp;&amp; ruleTypeSelect == 3 &amp;&amp; !$legacy"
          requiredIf="typeSelect != 4 &amp;&amp; ruleTypeSelect == 3"/>
        <field name="groupsWithoutColumn"
          showIf="reportTypeColumn != null &amp;&amp; typeSelect != 5 &amp;&amp; !$legacy"/>
      </panel>
      <panel name="groupConfigPanel" showIf="typeSelect == 4" colSpan="12">
        <field name="hidden"/>
        <field name="computeOtherPeriod"
          showIf="reportTypeColumn != null &amp;&amp; ruleTypeSelect == 2"/>
      </panel>
      <panel name="splitConfigPanel" colSpan="12" itemSpan="4"
        showIf="ruleTypeSelect == 2 &amp;&amp; reportType != null &amp;&amp; !$legacy">
        <field name="detailByAccountType" hideIf="detailByAccount || detailByAnalyticAccount"/>
        <field name="detailByAccount" hideIf="detailByAccountType || detailByAnalyticAccount"/>
        <field name="detailByAnalyticAccount" hideIf="detailByAccountType || detailByAccount"/>
      </panel>
      <field name="$helpCode" title="Account code" readonly="true"
        showIf="typeSelect == 5 || ruleTypeSelect == 2" colSpan="12">
        <viewer depends="typeSelect,ruleTypeSelect">
					<![CDATA[
						<p ng-show="record.typeSelect == 5 || record.ruleTypeSelect == 2">
							<span x-translate>The account code field allows to add every account whose code will fulfill the given regular expression.</span><br>
							<span x-translate>This regular expression must be of the SQL syntax. The most useful terms are :</span><br>
							<span x-translate>% to match any character</span><br>
							<span x-translate>[] to match any character in the brackets</span><br>
							<span x-translate>[^] to match any character not listed in the brackets</span><br>
						</p>
					]]>
        </viewer>
      </field>
      <field name="accountCode" showIf="typeSelect == 5 || ruleTypeSelect == 2" colSpan="12"/>
      <field name="analyticAccountCode" showIf="ruleTypeSelect == 2" colSpan="12"/>
      <field name="$helpRule" title="Rule" readonly="true" showIf="ruleTypeSelect == 3"
        colSpan="12">
        <viewer depends="ruleTypeSelect">
					<![CDATA[
						<p ng-show="record.ruleTypeSelect == 3">
							<span x-translate>This state allows to create a custom rule to be shown in the report.</span><br>
							<span x-translate>Any Javascript operation can be written and the computed result will be displayed, but there must be only one line.</span><br>
							<span x-translate>A previous result can be used with the following syntax : rules["code"] where code is the "code" field of a previous config line.</span>
						</p>
					]]>
        </viewer>
      </field>
      <field name="rule" showTitle="false" widget="code-editor" x-code-syntax="javascript"
        showIf="ruleTypeSelect == 3" colSpan="12"/>
    </panel>
    <panel-related name="accountingReportConfigLineAccountTypeSetPanel"
      field="accountTypeSet" colSpan="12" form-view="account-type-form"
      grid-view="account-type-grid" showIf="typeSelect == 5 || ruleTypeSelect == 2"/>
    <panel-related name="accountingReportConfigLineAccountSetPanel" field="accountSet"
      colSpan="12" form-view="account-form" grid-view="account-grid"
      showIf="typeSelect == 5 || ruleTypeSelect == 2"
      onSelect="action-accounting-report-config-line-attrs-account-set-domain"/>
    <panel-related name="accountingReportConfigLineAnalyticAccountSetPanel"
      field="analyticAccountSet" colSpan="12" showIf="ruleTypeSelect == 2"
      form-view="analytic-account-form" grid-view="analytic-account-grid"/>

  </form>

  <action-group name="action-accounting-report-config-line-group-line-onnew">
    <action name="action-accounting-report-config-line-record-line-rule"/>
    <action name="action-accounting-report-config-line-attrs-set-legacy"/>
  </action-group>

  <action-record
    name="action-accounting-report-config-line-record-type-select-onchange"
    model="com.axelor.apps.account.db.AccountingReportConfigLine">
    <field name="ruleTypeSelect" expr="1" if="typeSelect == 3"/>
    <field name="code" expr="eval: null" if="typeSelect == 3"/>
    <field name="label" expr="eval: null" if="typeSelect == 3"/>
  </action-record>

  <action-record
    name="action-accounting-report-config-lone-record-rule-type-select-onchange"
    model="com.axelor.apps.account.db.AccountingReportConfigLine">
    <field name="code" expr="eval: null" if="ruleTypeSelect == 1"/>
    <field name="label" expr="eval: null" if="ruleTypeSelect == 1"/>
  </action-record>

  <action-record name="action-accounting-report-config-line-record-column-rule"
    model="com.axelor.apps.account.db.AccountingReportConfigLine">
    <field name="reportTypeColumn" expr="eval: __parent__"/>
  </action-record>

  <action-record name="action-accounting-report-config-line-record-line-rule"
    model="com.axelor.apps.account.db.AccountingReportConfigLine">
    <field name="reportType" expr="eval: __parent__"/>
  </action-record>

  <action-attrs name="action-accounting-report-config-line-attrs-account-set-domain">
    <attribute for="accountSet" name="domain"
      expr="eval: &quot; self.company = ${__parent__.company?.id} &quot;"
      if="_parent != null &amp;&amp; _parent._model == 'com.axelor.apps.account.db.AccountingReportType'"/>
  </action-attrs>

  <action-attrs name="action-accounting-report-config-line-attrs-set-legacy">
    <attribute name="value" for="$legacy" expr="eval: __parent__?.useLegacyCustomReports"/>
  </action-attrs>

  <action-view name="action-move-line-view-open-report-config-line" title="Config lines"
    model="com.axelor.apps.account.db.AccountingReportConfigLine">
    <view type="grid" name="accounting-report-config-line-grid"/>
    <view type="form" name="accounting-report-config-line-form"/>
    <view-param name="forceEdit" value="true"/>
    <context name="_showRecord" expr="eval: id"/>
  </action-view>

</object-views>