---
title: "Sale order: fixed the value of 'Invoiced Amount (excl. tax)' in case of multi-order invoices."
module: axelor-supplychain
developer: |
  -- migration script to update amount_invoiced in Sale Order table

  UPDATE sale_sale_order SaleOrder
  SET amount_invoiced =
  (
      CASE
        WHEN SaleOrder.currency <> Company.currency
         AND SaleOrder.company_ex_tax_total <> 0
        THEN SaleOrder.ex_tax_total *
            (
                (
                    COALESCE((
                        SELECT SUM(InvoiceLine.company_ex_tax_total)
                        FROM account_invoice_line InvoiceLine
                        JOIN account_invoice Invoice ON Invoice.id = InvoiceLine.invoice
                        WHERE InvoiceLine.sale_order_line IN (
                            SELECT id FROM sale_sale_order_line WHERE sale_order = SaleOrder.id
                        )
                        AND Invoice.operation_type_select = 3
                        AND Invoice.status_select = 3
                    ), 0)
                    -
                    COALESCE((
                        SELECT SUM(InvoiceLine.company_ex_tax_total)
                        FROM account_invoice_line InvoiceLine
                        JOIN account_invoice Invoice ON Invoice.id = InvoiceLine.invoice
                        WHERE InvoiceLine.sale_order_line IN (
                            SELECT id FROM sale_sale_order_line WHERE sale_order = SaleOrder.id
                        )
                        AND Invoice.operation_type_select = 4
                        AND Invoice.status_select = 3
                    ), 0)
                ) / SaleOrder.company_ex_tax_total
            )
        ELSE
            COALESCE((
                SELECT SUM(InvoiceLine.company_ex_tax_total)
                FROM account_invoice_line InvoiceLine
                JOIN account_invoice Invoice ON Invoice.id = InvoiceLine.invoice
                WHERE InvoiceLine.sale_order_line IN (
                    SELECT id FROM sale_sale_order_line WHERE sale_order = SaleOrder.id
                )
                AND Invoice.operation_type_select = 3
                AND Invoice.status_select = 3
            ), 0)
            -
            COALESCE((
                SELECT SUM(InvoiceLine.company_ex_tax_total)
                FROM account_invoice_line InvoiceLine
                JOIN account_invoice Invoice ON Invoice.id = InvoiceLine.invoice
                WHERE InvoiceLine.sale_order_line IN (
                    SELECT id FROM sale_sale_order_line WHERE sale_order = SaleOrder.id
                )
                AND Invoice.operation_type_select = 4
                AND Invoice.status_select = 3
            ), 0)
      END
  )
  FROM base_company Company
  WHERE SaleOrder.company = Company.id;
