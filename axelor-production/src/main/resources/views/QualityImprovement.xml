<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_8.0.xsd">

  <form id="production-quality-improvement-form" name="quality-improvement-form"
    title="Quality improvement" model="com.axelor.apps.quality.db.QualityImprovement" width="large"
    extension="true">

    <extend target="//panel[@name='intPanel']/field[@name='writtenOn']">
      <insert position="after">
        <field name="manufOrder" hideIf="$get('qi.type') == 2"
          onChange="action-quality-improvement-group-manuf-order-on-change"
          if="__config__.app.isApp('production')"/>
        <field name="operationOrder" showIf="manufOrder != null"
          onChange="action-quality-improvement-method-set-written-on-and-written-by"
          onSelect="action-quality-improvement-attrs-set-operation-order-domain"
          if="__config__.app.isApp('production')"/>
        <field name="toConsumeProdProduct" showIf="manufOrder != null"
          onChange="action-quality-improvement-method-set-written-on-and-written-by"
          onSelect="action-quality-improvement-attrs-set-to-consume-prod-product-domain"
          if="__config__.app.isApp('production')"/>
        <field name="consumedProdProduct" showIf="manufOrder != null"
          onChange="action-quality-improvement-method-set-written-on-and-written-by"
          onSelect="action-quality-improvement-attrs-set-consume-prod-product-domain"
          if="__config__.app.isApp('production')"/>
      </insert>
    </extend>
  </form>

  <action-attrs name="action-quality-improvement-attrs-set-operation-order-domain">
    <attribute name="domain" for="operationOrder"
      expr="eval: &quot; self.id IN (${manufOrder?.operationOrderList?.collect{it.id}.join(',')}) &quot;"
      if="!manufOrder.operationOrderList.isEmpty()"/>
    <attribute name="domain" for="operationOrder"
      expr="eval: &quot; self.id IN (0) &quot;" if="manufOrder.operationOrderList.isEmpty()"/>
  </action-attrs>

  <action-attrs
    name="action-quality-improvement-attrs-set-to-consume-prod-product-domain">
    <attribute name="domain" for="toConsumeProdProduct"
      expr="eval: &quot; self.id IN (${manufOrder?.toConsumeProdProductList?.collect{it.id}.join(',')}) &quot;"
      if="!manufOrder.toConsumeProdProductList.isEmpty()"/>
    <attribute name="domain" for="toConsumeProdProduct"
      expr="eval: &quot; self.id IN (0) &quot;" if="manufOrder.toConsumeProdProductList.isEmpty()"/>
  </action-attrs>

  <action-attrs name="action-quality-improvement-attrs-set-consume-prod-product-domain">
    <attribute name="domain" for="consumedProdProduct"
      expr="eval: &quot; self.id IN (${manufOrder?.consumedStockMoveLineList?.collect{it.id}.join(',')}) &quot;"
      if="!manufOrder.consumedStockMoveLineList.isEmpty()"/>
    <attribute name="domain" for="consumedProdProduct"
      expr="eval: &quot; self.id IN (0) &quot;" if="manufOrder.consumedStockMoveLineList.isEmpty()"/>
  </action-attrs>

  <action-group name="action-quality-improvement-group-manuf-order-on-change">
    <action name="action-quality-improvement-validate-manuf-order-on-change"/>
    <action name="action-quality-improvement-record-manuf-order-on-change-set-values"/>
    <action name="action-quality-improvement-method-set-written-on-and-written-by"/>
    <action name="action-quality-improvement-attrs-set-dummy-field-values"/>
  </action-group>

  <action-validate name="action-quality-improvement-validate-manuf-order-on-change">
    <alert
      message="The following fields will be reset: manufacturing operation line, manuf Order product to consume, consummed manuf order product , continue ?"
      if="operationOrder != null || toConsumeProdProduct != null || consumedProdProduct != null"
      action="action-quality-improvement-attrs-on-validate-set-field-values"/>
  </action-validate>

  <action-record
    name="action-quality-improvement-record-manuf-order-on-change-set-values"
    model="com.axelor.apps.quality.db.QIIdentification">
    <field name="operationOrder" expr="eval: null"/>
    <field name="toConsumeProdProduct" expr="eval: null"/>
    <field name="consumedProdProduct" expr="eval: null"/>
  </action-record>

  <action-attrs name="action-quality-improvement-attrs-set-dummy-field-values-onload"
    id="production-action-quality-improvement-attrs-set-dummy-field-values-onload">
    <attribute name="value" for="qiIdentification.$dummyCustomerPartner"
      expr="eval: qiIdentification.customerPartner" if="qiIdentification.customerPartner != null"/>
    <attribute name="value" for="qiIdentification.$dummySupplierPartner"
      expr="eval: qiIdentification.supplierPartner" if="qiIdentification.supplierPartner != null"/>
    <attribute name="value" for="qiIdentification.$dummyCustomerSaleOrder"
      expr="eval: qiIdentification.customerSaleOrder"
      if="qiIdentification.customerSaleOrder != null"/>
    <attribute name="value" for="qiIdentification.$dummyCustomerSaleOrderLine"
      expr="eval: qiIdentification.customerSaleOrderLine"
      if="qiIdentification.customerSaleOrderLine != null"/>
    <attribute name="value" for="qiIdentification.$dummySupplierPurchaseOrder"
      expr="eval: qiIdentification.supplierPurchaseOrder"
      if="qiIdentification.supplierPurchaseOrder != null"/>
    <attribute name="value" for="qiIdentification.$dummySupplierPurchaseOrderLine"
      expr="eval: qiIdentification.supplierPurchaseOrderLine"
      if="qiIdentification.supplierPurchaseOrderLine != null"/>
    <attribute name="value" for="qiIdentification.$dummyStockMove"
      expr="eval: qiIdentification.stockMove" if="qiIdentification.stockMove != null"/>
    <attribute name="value" for="qiIdentification.$dummyStockMoveLine"
      expr="eval: qiIdentification.stockMoveLine" if="qiIdentification.stockMoveLine != null"/>
    <attribute name="value" for="qiIdentification.$dummyManufOrder"
      expr="eval: qiIdentification.manufOrder" if="qiIdentification.manufOrder != null"/>
  </action-attrs>

  <action-attrs name="action-quality-improvement-attrs-on-validate-set-field-values"
    id="production-action-quality-improvement-attrs-on-validate-set-field-values">
    <attribute name="value" for="customerPartner" expr="eval: dummyCustomerPartner"/>
    <attribute name="value" for="supplierPartner" expr="eval: dummySupplierPartner"/>
    <attribute name="value" for="customerSaleOrder" expr="eval: dummyCustomerSaleOrder"/>
    <attribute name="value" for="customerSaleOrderLine"
      expr="eval: dummyCustomerSaleOrderLine"/>
    <attribute name="value" for="supplierPurchaseOrder"
      expr="eval: dummySupplierPurchaseOrder"/>
    <attribute name="value" for="supplierPurchaseOrderLine"
      expr="eval: dummySupplierPurchaseOrderLine"/>
    <attribute name="value" for="stockMove" expr="eval: dummyStockMove"/>
    <attribute name="value" for="stockMoveLine" expr="eval: dummyStockMoveLine"/>
    <attribute name="value" for="manufOrder" expr="eval: dummyManufOrder"/>
  </action-attrs>

</object-views>
