<?xml version="1.0" encoding="UTF-8"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_6.1.xsd">

  <grid name="global-budget-grid" title="Global Budget"
    model="com.axelor.apps.budget.db.GlobalBudget" orderBy="code">
    <field name="name"/>
    <field name="code" x-bind="{{code|unaccent|uppercase}}"/>
    <field name="fromDate"/>
    <field name="toDate"/>
    <field name="statusSelect"/>
    <field name="activeVersion"/>
    <field name="activeVersion.totalAmountExpected" title="Total Amount Expected" aggregate="sum"/>
    <field name="typeSelect"/>
    <field name="totalAmountCommitted"/>
    <field name="realizedWithNoPo"/>
    <field name="realizedWithPo"/>
  </grid>

  <form name="global-budget-form" title="Global Budget" model="com.axelor.apps.budget.db.GlobalBudget"
        width="large" onNew="budget-action-budget-group-onnew"
        onLoad="budget-action-budget-group-onload"
        onSave="budget-action-method-create-check-budget-key,budget-action-method-create-check-dates-on-budget">

    <panel name="mainPanel">
      <field name="statusSelect" showTitle="false" colSpan="12" widget="NavSelect"
             readonly="true" hidden="true"/>
      <field name="fullName" hidden="true" showTitle="false" colSpan="12"/>
      <field name="code" required="true" colSpan="2"/>
      <field name="name" required="true" colSpan="4"/>
      <field name="budgetLevel" readonlyIf="$popup()" colSpan="3" requiredIf="!$popup()"
             onChange="action-budget-record-set-default-values-budget-level,budget-action-method-budget-manage-budget-key"
             domain="self.parentBudgetLevel.parentBudgetLevel != null"/>
      <field name="budgetLevel.parentBudgetLevel.parentBudgetLevel" title="Global budget"
             colSpan="3" grid-view="budget-level-grid" form-view="budget-level-form"/>
      <field name="typeSelect" colSpan="3"/>
      <field name="sourceSelect" colSpan="3"/>
      <field name="budgetKey" colSpan="6" readonly="true"/>
      <panel name="datesPanel" colSpan="12">
        <field name="fromDate" colSpan="3" readonlyIf="statusSelect == 2"
               onChange="action-budget-budget-validate-dates" required="true"/>
        <field name="toDate" colSpan="3" readonlyIf="statusSelect == 2"
               onChange="action-budget-budget-validate-dates" required="true"/>
        <field name="company" hidden="true"/>
        <field name="company.currency" hidden="true"/>
      </panel>
    </panel>

    <panel name="totalAmountExpectedPanel" readonly="true" colSpan="12" title="Initial"
           itemSpan="3">
      <field name="totalAmountExpected"/>
      <field name="totalAmountCommitted" if-module="axelor-supplychain"
             if="__config__.app.isApp('supplychain')"/>
      <field name="realizedWithNoPo"/>
      <field name="realizedWithPo"/>
      <field name="simulatedAmount"/>
      <field name="availableAmount"/>
      <field name="availableAmountWithSimulated"/>
      <field name="totalFirmGap"/>
      <field name="totalAmountPaid"/>
      <field name="totalAmountRealized" hidden="true"/>
      <separator colSpan="12"/>
    </panel>
  </form>

  <action-validate name="action-budget-validate-generate-period">
    <error message="To generate periods, please fill in the limits of the budget."
      if="fromDate == null || toDate == null"/>
    <error message="To generate periods, please fill in the Period duration."
      if="periodDurationSelect == null"/>
    <alert message="Warning, existing lines will be deleted, do you wish to continue?"
      if="budgetLineList != null &amp;&amp; !budgetLineList.empty"/>
  </action-validate>

  <action-method name="action-budget-method-compute-total-amount">
    <call class="com.axelor.apps.budget.web.BudgetController" method="computeTotalAmount"/>
  </action-method>

  <action-validate name="action-budget-validate-exceed-line-amount">
    <alert
      if="__config__.app.getApp('budget')?.manageMultiBudget
                  &amp;&amp;budgetDistributionList != null &amp;&amp; budgetDistributionList
                  &amp;&amp; companyInTaxTotal &gt; budgetDistributionList?.sum{it.amount}"
      message="The total amount is greater than the budget distribution total."/>
  </action-validate>

  <action-group name="budget-action-budget-group-onnew">
    <action name="action-budget-record-on-new"/>
    <action name="budget-action-budget-attrs-set-attrs"/>
    <action name="budget-action-method-show-period-fields"/>
    <action name="budget-action-method-budget-manage-budget-key"/>
  </action-group>

  <action-group name="budget-action-budget-group-onload">
    <action name="budget-action-budget-attrs-set-attrs"/>
    <action name="budget-action-method-budget-manage-budget-key"/>
    <action name="budget-action-method-show-period-fields"/>
  </action-group>

  <action-attrs name="budget-action-budget-attrs-set-attrs">
    <attribute name="domain" for="budgetLevel" expr="eval: _domain"/>
    <attribute name="hidden" for="accountSet"
      expr="eval: !(typeSelect == com.axelor.apps.budget.db.repo.BudgetRepository.BUDGET_TYPE_SELECT_BUDGET)"/>
    <attribute name="hidden" for="accountModelSet"
      expr="eval: !(typeSelect == com.axelor.apps.budget.db.repo.BudgetRepository.BUDGET_TYPE_SELECT_TEMPLATE)"/>
    <attribute name="title" for="availableAmont"
      expr="eval: com.axelor.i18n.I18n.get('Remains for sale')"
      if="budgetLevel?.parentBudgetLevel?.parentBudgetLevel?.budgetTypeSelect == 2"/>
    <attribute for="code" name="focus" expr="true"/>
  </action-attrs>


  <action-validate name="action-budget-budget-validate-dates">
    <error message="Invalid dates"
      if="toDate != null &amp;&amp; fromDate != null &amp;&amp; toDate &lt; fromDate"
      action="action-budget-budget-record-null-toDate"/>
  </action-validate>

  <action-record name="action-budget-budget-record-null-toDate"
    model="com.axelor.apps.budget.db.Budget">
    <field name="toDate" expr="eval: null"/>
  </action-record>

  <action-view name="action-budget-budget-view-budget" title="Budgets"
    model="com.axelor.apps.budget.db.Budget">
    <view type="form" name="budget-included-form"/>
    <context name="_showRecord" expr="eval: id"/>
  </action-view>

  <action-view name="action-budget-budget-view-budget-template" title="Budgets"
    model="com.axelor.apps.budget.db.Budget">
    <view type="form" name="budget-included-template-form"/>
    <context name="_showRecord" expr="eval: id"/>
  </action-view>

  <action-method name="action-budget-budget-method-generate-periods">
    <call class="com.axelor.apps.budget.web.BudgetController" method="generatePeriods"/>
  </action-method>

  <action-method name="action-budget-budget-compute-amounts">
    <call class="com.axelor.apps.budget.web.BudgetController"
      method="computeToBeCommittedAndFirmGap"/>
  </action-method>

  <action-method name="budget-action-method-budget-manage-budget-key">
    <call class="com.axelor.apps.budget.web.BudgetController" method="manageBudgetKey"/>
  </action-method>

  <action-method name="action-budget-method-set-account-set-domain">
    <call class="com.axelor.apps.budget.web.BudgetController" method="setAccountDomain"/>
  </action-method>

  <action-method name="budget-action-method-show-period-fields">
    <call class="com.axelor.apps.budget.web.BudgetController" method="managePeriodFields"/>
  </action-method>

  <action-method name="budget-action-method-create-check-budget-key">
    <call class="com.axelor.apps.budget.web.BudgetController" method="createBudgetKey"/>
  </action-method>

  <action-method name="budget-action-method-create-check-dates-on-budget">
    <call class="com.axelor.apps.budget.web.BudgetController" method="checkDatesOnBudget"/>
  </action-method>

  <action-method name="action-method-budget-analytic-axis-set-domain">
    <call class="com.axelor.apps.budget.web.BudgetController" method="setAnalyticAxisDomain"/>
  </action-method>

  <action-method name="action-method-budget-analytic-account-set-domain">
    <call class="com.axelor.apps.budget.web.BudgetController" method="setAnalyticAccountDomain"/>
  </action-method>

  <action-validate name="action-budget-validate-exceed-line-amount-extax">
    <alert
      if="__config__.app.getApp('budget')?.manageMultiBudget
                  &amp;&amp; budgetDistributionList != null &amp;&amp; budgetDistributionList
                  &amp;&amp; companyExTaxTotal &gt; budgetDistributionList?.sum{it.amount}"
      message="The total amount is greater than the budget distribution total."/>
  </action-validate>

  <action-group name="action-group-budget-generateperiod-click">
    <action name="action-year-check-date"/>
    <action name="save"/>
    <action name="action-budget-validate-generate-period"/>
    <action name="action-budget-budget-method-generate-periods"/>
    <action name="action-budget-method-compute-total-amount"/>
    <action name="action-budget-budget-compute-amounts"/>
  </action-group>
  <search-filters name="budget-filters" model="com.axelor.apps.budget.db.Budget"
    title="Budget filters">
    <field name="company" hidden="true"
      if="!__config__.app.getApp('base')?.getEnableMultiCompany()"/>
    <field name="totalAmountCommitted" hidden="true" if="!__config__.app.isApp('supplychain')"/>
  </search-filters>
</object-views>
