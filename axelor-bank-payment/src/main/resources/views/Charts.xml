<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<object-views xmlns="http://axelor.com/xml/ns/object-views"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://axelor.com/xml/ns/object-views http://axelor.com/xml/ns/object-views/object-views_5.4.xsd">

  <chart name="chart.sales.turnover.per.analytic.account.per.month"
    title="Turnover invoiced of first Analytic Axis by Month"
    onInit="action.chart.set.active.company">
    <search-fields>
      <field name="_company" title="Company" type="reference"
        target="com.axelor.apps.base.db.Company"/>
    </search-fields>
    <dataset type="jpql"><![CDATA[

	  SELECT

				SUM(sign(_moveLine.credit-_moveLine.debit)*self.amount) AS amount,
				_analyticAccount.name as analyticAccountName,
	to_char(_moveLine.date,'yyyy-MM') as month
	  FROM
				AnalyticMoveLine self
	  LEFT JOIN
				self.analyticAccount as _analyticAccount
	  LEFT JOIN
	      self.moveLine as _moveLine
	  LEFT JOIN
				_moveLine.move as _move
		LEFT JOIN
				_moveLine.account as _account
	  LEFT JOIN
				self.analyticAxis as _analyticAxis
	  WHERE
	      (_move.statusSelect = 3 OR _move.statusSelect = 2) AND (:_company is null OR _move.company = :_company)
	 			AND _account.code LIKE '7%'  AND _analyticAxis.code = 'AXE1'
	  GROUP BY
	      to_char(_moveLine.date,'yyyy-MM'),
				_analyticAccount.name
	  ORDER BY
	      month

	  ]]></dataset>
    <category key="month" type="month"/>
    <series key="amount" groupBy="analyticAccountName" type="bar"/>
    <!-- <config name="colors" value="blue,yellow,red,green" /> -->
    <config name="colors"
      value="#f63,#28a745,#007bff,#ffc107,#6c757d,#6f42c1,#17a2b8,#dc3545,#6f42c1,#f8f9fa"/>

  </chart>

  <chart name="chart.purchases.invoice.per.month.pie"
    title="Supplier invoice by reason of refusal to pay" onInit="action.chart.set.active.company">
    <search-fields>
      <field name="_company" title="Company" type="reference"
        target="com.axelor.apps.base.db.Company"/>
    </search-fields>
    <dataset type="jpql"><![CDATA[

	  SELECT
	      SUM(self.companyInTaxTotalRemaining) AS amountRemaining,
	      _reasonOfRefusalToPay.name AS reasonOfRefusalToPayName,
	      _reasonOfRefusalToPay.id AS _reasonOfRefusalToPayNameId
	  FROM
	      Invoice self
	  LEFT JOIN
	      self.reasonOfRefusalToPay as _reasonOfRefusalToPay

	  WHERE
	      self.statusSelect in (2,3) AND (:_company is null OR self.company = :_company)
	      AND (self.operationTypeSelect = 1 OR self.operationTypeSelect = 2) AND self.pfpValidateStatusSelect = 3
	  GROUP BY
	      _reasonOfRefusalToPay.id,
	      _reasonOfRefusalToPay.name

	  ORDER BY
	      _reasonOfRefusalToPay.name

	  ]]></dataset>
    <category key="reasonOfRefusalToPayName" type="text"/>
    <series key="amountRemaining" type="pie" title="Amount (in euro)"/>
    <config name="colors" value="#f63,#28a745,#007bff,#ffc107,#6c757d,#6f42c1,#17a2b8"/>
    <config name="percent" value="true"/>
    <config name="onClick" value="account.root.payments.suppl.invoices.to.pay.from.chart"/>
  </chart>

  <custom name="report-delay-rate" title="Supplier's delay on payment" css="report-box">
    <dataset type="sql"><![CDATA[

	 Select 100 * (select sum((self.operation_type_select + 1.5) * 2 * self.company_ex_tax_total)
	  from account_invoice as self
	  WHERE self.status_select = 3 and self.amount_remaining > 0
	  and (self.operation_type_select = 1 OR self.operation_type_select = 2) and self.due_date <= :__date__) / (select sum((self.operation_type_select + 1.5)*2*self.company_ex_tax_total)
	  from account_invoice as self
	  WHERE self.status_select = 3 and self.amount_remaining > 0
	  and (self.operation_type_select = 1 OR self.operation_type_select = 2)) as total,

	   (select sum( :__date__ - self.due_date)
	  from account_invoice as self
	  WHERE self.status_select = 3 and self.amount_remaining > 0
	  and (self.operation_type_select = 1 OR self.operation_type_select = 2) and self.due_date <= :__date__) / (select count(id)
	  from account_invoice as self
	  WHERE self.status_select = 3 and self.amount_remaining > 0
	  and (self.operation_type_select = 1 OR self.operation_type_select = 2) and self.due_date <= :__date__) as avgdelay

	  ]]></dataset>
    <template><![CDATA[

	  <div class="report-data">
	    <h1>{{first.total | number : 2}} %</h1>

	    <small x-translate>Delay rate</small>
	    <div class="report-percent font-bold text-error pull-right">
	     <span x-translate>Average delay :</span> {{first.avgdelay | number : 2}} <span x-translate> days</span>
	    </div>
	    <div class="report-tags"><span class="label label-success" x-translate>Today</span></div>
	  </div>

	  ]]></template>
  </custom>

  <custom name="report-supplier-amount-remaining" title="Supplier amount in progress"
    css="report-box">
    <dataset type="sql"><![CDATA[

	 Select  (select sum(self.company_in_tax_total_remaining)
	  from account_invoice as self
	  WHERE self.status_select = 3
	  and self.operation_type_select = 1)
	- COALESCE((select sum(self.company_in_tax_total_remaining)
	  from account_invoice as self
	  WHERE self.status_select = 3
	  and self.operation_type_select = 2), 0) as total

	  ]]></dataset>
    <template><![CDATA[

	  <div class="report-data">
	    <h1>{{first.total | number : 2}} €</h1>
	  </div>

	  ]]></template>
  </custom>

  <custom name="report-top-3-suppliers" title="Top 3 supplier" css="report-box">
    <dataset type="jpql"><![CDATA[

	  select CONCAT(ceil(sum((self.operationTypeSelect + 1.5)*2*self.companyExTaxTotal)), ' €') as Amount, _partner.name as Supplier
	  from Invoice as self
	  left join self.partner as _partner
	  where self.statusSelect = 3
	  and self.operationTypeSelect in (1,2)
	  group by _partner.id
	  order by Montant desc


	  ]]></dataset>
    <template><![CDATA[

	 <report-table data='data' columns='Supplier,Amount'></report-table>


	  ]]></template>
  </custom>

</object-views>